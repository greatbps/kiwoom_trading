================================================================================
ğŸ”§ ë²„ê·¸ ìˆ˜ì •: DatetimeIndex ë³€í™˜ ì˜¤ë¥˜
================================================================================

ì‘ì„±ì¼: 2025-11-17
ìˆ˜ì •ì: Claude Code
ìƒíƒœ: âœ… FIXED

================================================================================
âŒ ë¬¸ì œ ì¦ìƒ
================================================================================

ì—ëŸ¬ ë©”ì‹œì§€:
```
TypeError: Only valid with DatetimeIndex, TimedeltaIndex or PeriodIndex,
but got an instance of 'RangeIndex'
```

ë°œìƒ ìœ„ì¹˜:
- analyzers/multi_timeframe_consensus.py:133
- df_1m.resample('5min') í˜¸ì¶œ ì‹œ

ì˜í–¥ ë²”ìœ„:
- L3 Multi-Timeframe Consensus ì²´í¬ ì‹¤íŒ¨
- ëª¨ë“  ì¢…ëª©ì´ "5ë¶„ë´‰ ë°ì´í„° ë¶€ì¡±" ì˜¤ë¥˜ë¡œ ì§„ì… ë¶ˆê°€

================================================================================
ğŸ” ì›ì¸ ë¶„ì„
================================================================================

1. **í‚¤ì›€ API ë°ì´í„° êµ¬ì¡°**
   - Kiwoom APIëŠ” DataFrameì„ RangeIndexë¡œ ë°˜í™˜
   - ì‹œê°„ ì •ë³´ëŠ” 'cntr_tm' ì»¬ëŸ¼ì— ë¬¸ìì—´ë¡œ ì €ì¥
   - ì˜ˆ: '20251117103500' (YYYYMMDDHHmmss)

2. **pandas resample() ìš”êµ¬ì‚¬í•­**
   - resample()ì€ ë°˜ë“œì‹œ DatetimeIndexë¥¼ ìš”êµ¬í•¨
   - RangeIndexë¡œëŠ” ì‹œê°„ ê¸°ë°˜ ë¦¬ìƒ˜í”Œë§ ë¶ˆê°€ëŠ¥

3. **ê¸°ì¡´ ì½”ë“œì˜ ë¬¸ì œ**
   ```python
   # âŒ WRONG: RangeIndex ìƒíƒœì—ì„œ ë°”ë¡œ resample ì‹œë„
   df_5m = df_1m.resample('5min').agg({...})
   ```

4. **Yahoo Finance vs Kiwoom**
   - Yahoo Finance: ì´ë¯¸ DatetimeIndexë¡œ ë°˜í™˜
   - Kiwoom API: RangeIndex + cntr_tm ì»¬ëŸ¼
   - ë‘ ì†ŒìŠ¤ë¥¼ ë™ì‹œì— ì§€ì›í•´ì•¼ í•¨

================================================================================
âœ… í•´ê²° ë°©ë²•
================================================================================

**íŒŒì¼**: analyzers/multi_timeframe_consensus.py

**ìœ„ì¹˜**: check_consensus() ë©”ì„œë“œ, line 120-130

**ìˆ˜ì • ì „**:
```python
# ì»¬ëŸ¼ëª… ì†Œë¬¸ì ë³€í™˜ (Yahoo Finance í˜¸í™˜)
if isinstance(df_1m.columns, pd.MultiIndex):
    df_1m.columns = [col[0].lower() if isinstance(col, tuple) else col.lower() for col in df_1m.columns]
else:
    df_1m.columns = df_1m.columns.str.lower()

# VWAP ê³„ì‚°
df_1m = self.analyzer.calculate_vwap(df_1m, use_rolling=True, rolling_window=20)
```

**ìˆ˜ì • í›„**:
```python
# ì»¬ëŸ¼ëª… ì†Œë¬¸ì ë³€í™˜ (Yahoo Finance í˜¸í™˜)
if isinstance(df_1m.columns, pd.MultiIndex):
    df_1m.columns = [col[0].lower() if isinstance(col, tuple) else col.lower() for col in df_1m.columns]
else:
    df_1m.columns = df_1m.columns.str.lower()

# ğŸ”§ CRITICAL: í‚¤ì›€ ë°ì´í„°ëŠ” RangeIndex â†’ DatetimeIndex ë³€í™˜ í•„ìš”
if 'cntr_tm' in df_1m.columns and not isinstance(df_1m.index, pd.DatetimeIndex):
    # cntr_tm: '20251117103500' â†’ datetime
    df_1m['datetime'] = pd.to_datetime(df_1m['cntr_tm'], format='%Y%m%d%H%M%S', errors='coerce')
    df_1m = df_1m.set_index('datetime')
    df_1m = df_1m.sort_index()  # ì‹œê°„ìˆœ ì •ë ¬
elif not isinstance(df_1m.index, pd.DatetimeIndex):
    # Yahoo Finance ë°ì´í„°ëŠ” ì´ë¯¸ DatetimeIndex
    # í•˜ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ í™•ì¸
    if 'datetime' in df_1m.columns:
        df_1m = df_1m.set_index('datetime')

# VWAP ê³„ì‚°
df_1m = self.analyzer.calculate_vwap(df_1m, use_rolling=True, rolling_window=20)
```

================================================================================
ğŸ§ª ê²€ì¦
================================================================================

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
```python
# í‚¤ì›€ API ì‹œë®¬ë ˆì´ì…˜
data = {
    'cntr_tm': ['20251117090000', '20251117090100', '20251117090200'],
    'close': [10000, 10100, 10200],
    'open': [9900, 10000, 10100],
    'high': [10100, 10200, 10300],
    'low': [9800, 9900, 10000],
    'volume': [1000, 1100, 1200]
}
df = pd.DataFrame(data)

# ë³€í™˜
df['datetime'] = pd.to_datetime(df['cntr_tm'], format='%Y%m%d%H%M%S')
df = df.set_index('datetime')

# ë¦¬ìƒ˜í”Œë§
df_resampled = df.resample('5min').agg({
    'open': 'first',
    'high': 'max',
    'low': 'min',
    'close': 'last',
    'volume': 'sum'
})
```

**ê²°ê³¼**: âœ… Success!

================================================================================
ğŸ“Š ì˜í–¥ ë¶„ì„
================================================================================

**ìˆ˜ì • ì „**:
- âŒ ëª¨ë“  ì¢…ëª© L3 ì‹¤íŒ¨
- âŒ "Only valid with DatetimeIndex" TypeError
- âŒ MTF í•©ì˜ ì²´í¬ ë¶ˆê°€ëŠ¥
- âŒ ì§„ì… ì‹ í˜¸ ì—†ìŒ

**ìˆ˜ì • í›„**:
- âœ… í‚¤ì›€ ë°ì´í„° â†’ DatetimeIndex ìë™ ë³€í™˜
- âœ… 1ë¶„ë´‰ â†’ 5ë¶„ë´‰ ë¦¬ìƒ˜í”Œë§ ì„±ê³µ
- âœ… 1ë¶„ë´‰ â†’ 15ë¶„ë´‰ ë¦¬ìƒ˜í”Œë§ ì„±ê³µ
- âœ… L3 MTF í•©ì˜ ì²´í¬ ì •ìƒ ë™ì‘
- âœ… Yahoo Finance ë°ì´í„°ë„ í˜¸í™˜ ìœ ì§€

================================================================================
ğŸ” ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­
================================================================================

1. **cntr_tm í¬ë§·**
   - í˜•ì‹: YYYYMMDDHHmmss
   - ì˜ˆì‹œ: '20251117103500' = 2025ë…„ 11ì›” 17ì¼ 10ì‹œ 35ë¶„ 00ì´ˆ
   - pandas to_datetime() format íŒŒë¼ë¯¸í„°: '%Y%m%d%H%M%S'

2. **errors='coerce' ì‚¬ìš© ì´ìœ **
   - ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì´ ìˆì„ ê²½ìš° NaT(Not a Time) ë°˜í™˜
   - í”„ë¡œê·¸ë¨ ì¤‘ë‹¨ ë°©ì§€

3. **sort_index() ì‚¬ìš© ì´ìœ **
   - í‚¤ì›€ APIëŠ” ìµœì‹  ë°ì´í„°ë¥¼ ë¨¼ì € ë°˜í™˜í•  ìˆ˜ ìˆìŒ
   - ì‹œê°„ìˆœ ì •ë ¬ ë³´ì¥ (ì˜¤ë˜ëœ ê²ƒ â†’ ìµœì‹  ìˆœ)

4. **isinstance() ì²´í¬**
   - Yahoo Finance ë°ì´í„°ëŠ” ì´ë¯¸ DatetimeIndex
   - ë¶ˆí•„ìš”í•œ ë³€í™˜ ë°©ì§€
   - ì„±ëŠ¥ ìµœì í™”

================================================================================
âš ï¸ ì£¼ì˜ì‚¬í•­
================================================================================

1. **cntr_tm ì»¬ëŸ¼ í•„ìˆ˜**
   - í‚¤ì›€ ë°ì´í„°ëŠ” ë°˜ë“œì‹œ cntr_tm í¬í•¨í•´ì•¼ í•¨
   - ì—†ìœ¼ë©´ ë³€í™˜ ë¶ˆê°€

2. **ì‹œê°„ ì •ë ¬**
   - resample() ì „ì— ë°˜ë“œì‹œ ì‹œê°„ìˆœ ì •ë ¬ í•„ìš”
   - sort_index() ìƒëµ ì‹œ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥

3. **NaT ì²˜ë¦¬**
   - ì˜ëª»ëœ ì‹œê°„ ë°ì´í„°ëŠ” NaTë¡œ ë³€í™˜ë¨
   - dropna()ë¡œ ì œê±° í•„ìš”

4. **ë©”ëª¨ë¦¬ íš¨ìœ¨**
   - set_index()ëŠ” ë³µì‚¬ë³¸ ìƒì„±
   - ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ì£¼ì˜

================================================================================
âœ… ê²°ë¡ 
================================================================================

Kiwoom API ë°ì´í„°ì˜ RangeIndexë¥¼ DatetimeIndexë¡œ ë³€í™˜í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•˜ì—¬
pandas resample() í˜¸ì¶œ ì‹œ ë°œìƒí•˜ëŠ” TypeErrorë¥¼ ì™„ì „íˆ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

ì´ì œ L3 Multi-Timeframe Consensusê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©°,
1ë¶„ë´‰ â†’ 5ë¶„ë´‰, 15ë¶„ë´‰ ë¦¬ìƒ˜í”Œë§ì´ ë¬¸ì œì—†ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.

================================================================================
