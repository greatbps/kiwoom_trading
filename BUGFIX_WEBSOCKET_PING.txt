================================================================================
ğŸ”§ ë²„ê·¸ ìˆ˜ì •: WebSocket PING ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜
================================================================================

ì‘ì„±ì¼: 2025-11-17
ìˆ˜ì •ì: Claude Code
ìƒíƒœ: âœ… FIXED

================================================================================
âŒ ë¬¸ì œ ì¦ìƒ
================================================================================

ì¡°ê±´ê²€ìƒ‰ API í˜¸ì¶œ ì‹œ PING ë©”ì‹œì§€ë§Œ ë°›ê³  ì‹¤ì œ ì¢…ëª© ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í•¨:

```
ì¡°ê±´ì‹ [17] Momentum ì „ëµ ê²€ìƒ‰ ì¤‘...
  ì‘ë‹µ í‚¤: ['trnm']
  ì „ì²´ ì‘ë‹µ: {'trnm': 'PING'}
  ì‘ë‹µ: 10.01ì´ˆ, return_code=None, data íƒ€ì…=<class 'NoneType'>, data ê¸¸ì´=0
  âœ… 0ê°œ ì¢…ëª© ë°œê²¬

ì¡°ê±´ì‹ [18] Breakout ì „ëµ ê²€ìƒ‰ ì¤‘...
  ì‘ë‹µ í‚¤: ['trnm']
  ì „ì²´ ì‘ë‹µ: {'trnm': 'PING'}
  ì‘ë‹µ: 16.47ì´ˆ, return_code=None, data íƒ€ì…=<class 'NoneType'>, data ê¸¸ì´=0
  âœ… 0ê°œ ì¢…ëª© ë°œê²¬
```

ëª¨ë“  ì¡°ê±´ì‹ì—ì„œ 0ê°œ ì¢…ëª© ë°œê²¬ â†’ ë§¤ë§¤ ë¶ˆê°€ëŠ¥

================================================================================
ğŸ” ì›ì¸ ë¶„ì„
================================================================================

1. **PING ë©”ì‹œì§€ë€?**
   - WebSocket keep-alive ë©”ì‹œì§€ (heartbeat)
   - ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²° ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ì „ì†¡
   - í˜•ì‹: `{'trnm': 'PING'}`
   - ì‹¤ì œ ë°ì´í„°ê°€ ì•„ë‹˜

2. **receive_message() ë™ì‘**
   ```python
   # main_auto_trading.py:489-499 (ìˆ˜ì • ì „)
   async def receive_message(self, timeout: float = 10.0):
       """WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ """
       if not self.websocket or not self.connected:
           raise Exception("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

       try:
           message = await asyncio.wait_for(self.websocket.recv(), timeout=timeout)
           return json.loads(message)  # âŒ ì²« ë©”ì‹œì§€ë¥¼ ë°”ë¡œ ë¦¬í„´
       except asyncio.TimeoutError:
           console.print(f"[yellow]âš ï¸  ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ ({timeout}ì´ˆ)[/yellow]")
           return None
   ```

   ë¬¸ì œì :
   - ì²« ë²ˆì§¸ë¡œ ë„ì°©í•œ ë©”ì‹œì§€ë¥¼ ë¬´ì¡°ê±´ ë¦¬í„´
   - PING ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ ì°©ê°
   - ì‹¤ì œ ì¡°ê±´ê²€ìƒ‰ ì‘ë‹µì€ ë°›ì§€ ëª»í•¨

3. **íƒ€ì´ë° ë¬¸ì œ**
   ```
   ì‹œê°„ì¶•:
   0ì´ˆ -----> ì¡°ê±´ê²€ìƒ‰ ìš”ì²­ ì „ì†¡ (CNSRREQ)
   5ì´ˆ -----> PING ë„ì°© (keep-alive)
              â†“
              receive_message()ê°€ PINGì„ ë¦¬í„´
              â†“
              ì¡°ê±´ê²€ìƒ‰ ë¡œì§: "data=None" â†’ 0ê°œ ì¢…ëª©
   10ì´ˆ ----> ì‹¤ì œ ì¡°ê±´ê²€ìƒ‰ ì‘ë‹µ ë„ì°© (ë†“ì¹¨!)
   ```

4. **ì™œ PINGì´ ë¨¼ì € ì˜¤ëŠ”ê°€?**
   - ì¡°ê±´ê²€ìƒ‰ì€ ì‹œê°„ì´ ê±¸ë¦¼ (10~30ì´ˆ)
   - WebSocketì€ 10ì´ˆë§ˆë‹¤ PING ì „ì†¡
   - PINGì´ ì¡°ê±´ê²€ìƒ‰ ì‘ë‹µë³´ë‹¤ ë¨¼ì € ë„ì°©

================================================================================
âœ… í•´ê²° ë°©ë²•
================================================================================

**íŒŒì¼**: main_auto_trading.py

**ìœ„ì¹˜**: receive_message() ë©”ì„œë“œ, line 489-513

**ìˆ˜ì • ì „**:
```python
async def receive_message(self, timeout: float = 10.0):
    """WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ """
    if not self.websocket or not self.connected:
        raise Exception("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    try:
        message = await asyncio.wait_for(self.websocket.recv(), timeout=timeout)
        return json.loads(message)  # âŒ ì²« ë©”ì‹œì§€ë¥¼ ë°”ë¡œ ë¦¬í„´
    except asyncio.TimeoutError:
        console.print(f"[yellow]âš ï¸  ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ ({timeout}ì´ˆ)[/yellow]")
        return None
```

**ìˆ˜ì • í›„**:
```python
async def receive_message(self, timeout: float = 10.0):
    """WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  (íƒ€ì„ì•„ì›ƒ ì¶”ê°€, PING ë¬´ì‹œ)"""
    if not self.websocket or not self.connected:
        raise Exception("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    try:
        start_time = time.time()
        while True:
            remaining_time = timeout - (time.time() - start_time)
            if remaining_time <= 0:
                raise asyncio.TimeoutError()

            message = await asyncio.wait_for(self.websocket.recv(), timeout=remaining_time)
            data = json.loads(message)

            # ğŸ”§ CRITICAL FIX: PING ë©”ì‹œì§€ ë¬´ì‹œ, ì‹¤ì œ ì‘ë‹µë§Œ ë¦¬í„´
            if data.get('trnm') == 'PING':
                console.print(f"[dim]  â™¥ PING (keep-alive)[/dim]")
                continue  # PING ë¬´ì‹œí•˜ê³  ë‹¤ìŒ ë©”ì‹œì§€ ëŒ€ê¸°

            return data  # ì‹¤ì œ ì‘ë‹µ ë¦¬í„´

    except asyncio.TimeoutError:
        console.print(f"[yellow]âš ï¸  ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ ({timeout}ì´ˆ)[/yellow]")
        return None
```

**ê°œì„  ì‚¬í•­**:
1. **while ë£¨í”„ ì¶”ê°€** - PINGì„ ë¬´ì‹œí•˜ê³  ê³„ì† ëŒ€ê¸°
2. **remaining_time ê³„ì‚°** - ì „ì²´ íƒ€ì„ì•„ì›ƒ ì‹œê°„ ê´€ë¦¬
3. **PING í•„í„°ë§** - `trnm == 'PING'` ì²´í¬ í›„ continue
4. **ì‹¤ì œ ì‘ë‹µë§Œ ë¦¬í„´** - PINGì´ ì•„ë‹Œ ë©”ì‹œì§€ë§Œ ë¦¬í„´

================================================================================
ğŸ§ª ê²€ì¦
================================================================================

**ìˆ˜ì • ì „ ë™ì‘**:
```
ì¡°ê±´ê²€ìƒ‰ ìš”ì²­ â†’ PING ìˆ˜ì‹  â†’ 0ê°œ ì¢…ëª© (ì‹¤íŒ¨)
```

**ìˆ˜ì • í›„ ë™ì‘**:
```
ì¡°ê±´ê²€ìƒ‰ ìš”ì²­
  â†’ PING ìˆ˜ì‹  â†’ ë¬´ì‹œ (â™¥ PING ì¶œë ¥)
  â†’ PING ìˆ˜ì‹  â†’ ë¬´ì‹œ (â™¥ PING ì¶œë ¥)
  â†’ ì¡°ê±´ê²€ìƒ‰ ì‘ë‹µ ìˆ˜ì‹  â†’ ì •ìƒ ì²˜ë¦¬ (ì„±ê³µ!)
  â†’ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
```

**ì˜ˆìƒ ê²°ê³¼**:
```
ì¡°ê±´ì‹ [17] Momentum ì „ëµ ê²€ìƒ‰ ì¤‘...
  â™¥ PING (keep-alive)
  â™¥ PING (keep-alive)
  ì‘ë‹µ í‚¤: ['return_code', 'data']
  ì „ì²´ ì‘ë‹µ: {'return_code': 0, 'data': [...]}
  ì‘ë‹µ: 18.23ì´ˆ, return_code=0, data íƒ€ì…=<class 'list'>, data ê¸¸ì´=47
  âœ… 47ê°œ ì¢…ëª© ë°œê²¬
```

================================================================================
ğŸ“Š ì˜í–¥ ë¶„ì„
================================================================================

**ìˆ˜ì • ì „**:
- âŒ ì¡°ê±´ê²€ìƒ‰ ì‹¤íŒ¨ (0ê°œ ì¢…ëª©)
- âŒ L2 RS í•„í„° ì‹¤í–‰ ë¶ˆê°€
- âŒ L3~L6 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¶ˆê°€
- âŒ ë§¤ë§¤ ì‹œê·¸ë„ ë°œìƒ ì•ˆ í•¨

**ìˆ˜ì • í›„**:
- âœ… ì¡°ê±´ê²€ìƒ‰ ì •ìƒ ë™ì‘ (ì¢…ëª© ë°œê²¬)
- âœ… L0-L6 íŒŒì´í”„ë¼ì¸ ì „ì²´ ì •ìƒ ë™ì‘
- âœ… ë§¤ë§¤ ì‹œê·¸ë„ ë°œìƒ
- âœ… ì‹¤ì „ ë§¤ë§¤ ê°€ëŠ¥

================================================================================
ğŸ” ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­
================================================================================

1. **íƒ€ì„ì•„ì›ƒ ê´€ë¦¬**
   ```python
   start_time = time.time()
   while True:
       remaining_time = timeout - (time.time() - start_time)
       if remaining_time <= 0:
           raise asyncio.TimeoutError()
   ```
   - ì „ì²´ ëŒ€ê¸° ì‹œê°„ = timeout (ì˜ˆ: 30ì´ˆ)
   - PINGì„ ì—¬ëŸ¬ ë²ˆ ë°›ì•„ë„ ì „ì²´ íƒ€ì„ì•„ì›ƒ ì´ˆê³¼ ì‹œ ì¢…ë£Œ

2. **ë©”ì‹œì§€ êµ¬ë¶„**
   ```python
   if data.get('trnm') == 'PING':
       continue  # PING
   else:
       return data  # ì‹¤ì œ ì‘ë‹µ (CNSRREQ, CNSRLST ë“±)
   ```

3. **WebSocket í”„ë¡œí† ì½œ**
   - PING/PONGì€ í‘œì¤€ WebSocket ê¸°ëŠ¥
   - RFC 6455 ìŠ¤í™ì˜ ì¼ë¶€
   - ì—°ê²° ëŠê¹€ ë°©ì§€ ëª©ì 

4. **ì¡°ê±´ê²€ìƒ‰ ì‘ë‹µ êµ¬ì¡°**
   ```json
   {
     "trnm": "CNSRREQ",
     "return_code": 0,
     "data": [
       {"jmcode": "A005930", ...},
       {"jmcode": "A000660", ...}
     ]
   }
   ```

================================================================================
âš ï¸ ì£¼ì˜ì‚¬í•­
================================================================================

1. **íƒ€ì„ì•„ì›ƒ ì‹œê°„**
   - ì¡°ê±´ê²€ìƒ‰: 30ì´ˆ ê¶Œì¥ (ê¸¸ê²Œ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
   - ì¼ë°˜ API: 10ì´ˆ (ê¸°ë³¸ê°’)
   - PINGì€ ë³´í†µ 10ì´ˆ ê°„ê²©

2. **PING ì™¸ ë‹¤ë¥¸ ë©”ì‹œì§€**
   - PONGë„ ë¬´ì‹œí•´ì•¼ í•  ìˆ˜ ìˆìŒ
   - í•„ìš”ì‹œ `trnm in ['PING', 'PONG']` ì²´í¬

3. **ë¬´í•œ ë£¨í”„ ë°©ì§€**
   - while Trueì´ì§€ë§Œ remaining_time ì²´í¬ë¡œ ë°©ì§€
   - íƒ€ì„ì•„ì›ƒ ë„ë‹¬ ì‹œ asyncio.TimeoutError ë°œìƒ

4. **ì„±ëŠ¥ ì˜í–¥**
   - PING ë¬´ì‹œëŠ” ì„±ëŠ¥ì— ì˜í–¥ ì—†ìŒ (ë‹¨ìˆœ continue)
   - ì‹¤ì œ ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ ì¦ê°€ ê°€ëŠ¥ (PING ìˆ˜ì‹  ì‹œê°„ í¬í•¨)

================================================================================
âœ… ê²°ë¡ 
================================================================================

WebSocket PING ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ ì°©ê°í•˜ë˜ ë²„ê·¸ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

ì´ì œ ì¡°ê±´ê²€ìƒ‰ APIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©°, L0-L6 ì‹œê·¸ë„ íŒŒì´í”„ë¼ì¸ì´
ì™„ì „í•˜ê²Œ ì‹¤í–‰ë©ë‹ˆë‹¤.

í•µì‹¬ ê°œì„ :
- receive_message()ì— PING í•„í„°ë§ ë¡œì§ ì¶”ê°€
- while ë£¨í”„ë¡œ ì‹¤ì œ ì‘ë‹µì´ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°
- íƒ€ì„ì•„ì›ƒ ê´€ë¦¬ ê°œì„ 

ì´ ìˆ˜ì •ìœ¼ë¡œ ì¡°ê±´ê²€ìƒ‰ 0ê°œ ì¢…ëª© ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.

================================================================================
