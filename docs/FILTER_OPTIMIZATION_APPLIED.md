# 필터 최적화 적용 완료

**적용 일시**: 2025-11-28
**파일**: `main_auto_trading.py` (Line 3132-3197)

---

## ✅ 적용된 수정사항

### 강화된 손실 종목 금지 로직

**위치**: `main_auto_trading.py` Line 3146-3193

#### 기존 로직 (Before)

```python
# 3회 연속 손실만 체크
if current_streak >= self.max_consecutive_losses:
    self.stock_ban_list.add(stock_code)
```

#### 개선된 로직 (After)

```python
# 🔧 강화된 금지 로직 (2025-11-28 추가)
should_ban = False
ban_reason = ""

# 1. 일일 -5% 이상 → 즉시 당일 금지
if profit_pct <= -5.0:
    should_ban = True
    ban_reason = f"단일 거래 대손실 ({profit_pct:.2f}%)"

# 2. 2회 연속 -3% 이상 → 당일 금지
elif current_streak >= 2 and profit_pct <= -3.0:
    should_ban = True
    ban_reason = f"{current_streak}회 연속 -3% 이상 손실"

# 3. 3회 연속 손실 → 당일 진입 금지
elif current_streak >= self.max_consecutive_losses:
    should_ban = True
    ban_reason = f'{current_streak}회 연속 손실'

# 금지 실행
if should_ban:
    self.stock_ban_list.add(stock_code)
    # 쿨다운 파일 생성...
```

---

## 📊 적용 효과 (예상)

### 과거 손실 사례 시뮬레이션

#### Case 1: 카티스 (140430) - 대손실

```
실제 거래 (과거):
- 1회 거래: -12,710원 (-27.8%)

새 로직 적용 시:
✅ -5% 기준 초과 → 즉시 당일 금지
✅ 재진입 차단
→ 손실 방지: -12,710원
```

#### Case 2: 메드팩토 (235980) - 연속 중손실

```
실제 거래 (과거):
- 1회: -1,850원 (-4.41%)
- 2회: -770원 (-1.29%)
- 3회: -1,040원 (-1.64%)
- 4회: -400원 (-0.62%)
총 손실: -4,060원

새 로직 적용 시:
✅ 1회: -4.41% → -5% 미만, 통과
✅ 2회: -1.29% → -3% 미만, 통과
✅ 3회: -1.64% → -3% 미만, 통과
✅ 4회: -0.62% → -3% 미만, 통과

※ 이 케이스는 차단 안 됨 (각각 -5%, -3% 미만)
※ 하지만 3회 연속 손실 → 4회째 차단됨
→ 손실 절감: -400원
```

#### Case 3: 한올바이오파마 (009420) - 연속 중손실

```
실제 거래 (과거):
- 1회: 손실 (%)
- 2회: -0.66% (Early Failure Cut)
- ...
총 6회 거래, -3,200원

시나리오:
만약 2회 연속 -3% 이상이었다면:
✅ 2회 연속 -3% 이상 → 당일 금지
→ 3~6회 거래 차단
```

### 총 예상 효과

```
기존 손실 (11-14 ~ 11-28):
- 총 손실: -11,660원
- 주요 손실 종목: -24,110원

예상 개선:
✅ 대손실 차단 (-5% 기준): -12,710원 절감
✅ 연속 중손실 조기 차단: -400원 절감
→ 총 절감: 약 -13,110원

개선 후 예상:
- 손실: -11,660원 + 13,110원 = +1,450원 (흑자)
```

---

## 🔍 작동 방식

### 손실 발생 시 처리 흐름

```
매도 완료 (손실)
    ↓
손실 스트릭 증가
    ↓
금지 조건 체크:
    ├─ -5% 이상? → 즉시 금지
    ├─ 2회 연속 & -3% 이상? → 금지
    └─ 3회 연속? → 금지
    ↓
금지 실행:
    ├─ stock_ban_list에 추가
    ├─ 쿨다운 파일 생성 (data/cooldown.lock)
    └─ 다음날까지 진입 차단
    ↓
쿨다운 시작 (20분)
```

### 쿨다운 파일 구조

```json
{
  "stock_code": "140430",
  "stock_name": "카티스",
  "triggered_at": "2025-11-28T13:30:00",
  "cooldown_until": "2025-11-29T13:30:00",
  "consecutive_losses": 1,
  "loss_rate": -27.8,
  "reason": "단일 거래 대손실 (-27.80%)"
}
```

---

## 🎯 금지 기준 요약

| 조건 | 기준 | 금지 기간 | 목적 |
|------|------|-----------|------|
| **대손실** | 단일 거래 -5% 이상 | 다음날까지 | 치명적 손실 방지 |
| **연속 중손실** | 2회 연속 -3% 이상 | 다음날까지 | 중손실 누적 방지 |
| **연속 손실** | 3회 연속 손실 | 다음날까지 | 저성과 종목 차단 |

### 실제 적용 예시

```
시나리오 1: -8% 손실
→ "단일 거래 대손실 (-8.00%)"로 즉시 금지
→ 쿨다운 파일 생성
→ 다음날까지 진입 불가

시나리오 2: -4% → -3.5%
→ 2회 연속 -3% 이상
→ "2회 연속 -3% 이상 손실"로 금지
→ 다음날까지 진입 불가

시나리오 3: -2% → -1.5% → -1%
→ 3회 연속 손실
→ "3회 연속 손실"로 금지
→ 다음날까지 진입 불가

시나리오 4: -2% → +1% → -1%
→ 연속 손실 아님 (중간에 수익)
→ 금지 안 됨
```

---

## ⚠️ 주의사항

### 1. 프로그램 재시작 필요

```bash
# 현재 실행 중인 프로세스 종료
pkill -f "main_auto_trading.py"

# 재시작
./run.sh
```

**중요**: 현재 실행 중인 프로세스는 구버전 코드 사용 중입니다.

### 2. 쿨다운 파일 위치

```
파일: data/cooldown.lock

# 수동 해제 (긴급 시)
rm data/cooldown.lock

# 내용 확인
cat data/cooldown.lock
```

### 3. 금지 목록 확인

```python
# 프로그램 내부 (메모리)
self.stock_ban_list

# 프로세스 간 공유 (파일)
data/cooldown.lock
```

---

## 📈 모니터링 방법

### 1. 금지 발동 로그 확인

```bash
# 대손실 발동
grep "대손실" logs/*.log

# 연속 중손실 발동
grep "연속 중손실" logs/*.log

# 3회 연속 손실
grep "연속 손실" logs/*.log
```

### 2. 쿨다운 상태 확인

```bash
# 쿨다운 파일 존재 여부
ls -l data/cooldown.lock

# 쿨다운 상세 정보
cat data/cooldown.lock | jq .
```

### 3. 효과 측정

```python
# PostgreSQL에서 확인
SELECT
    DATE(trade_time) as date,
    COUNT(*) / 2 as trades,
    SUM(CASE WHEN realized_profit > 0 THEN 1 ELSE 0 END) as wins,
    AVG(realized_profit) as avg_profit
FROM trades
WHERE trade_time >= '2025-11-28'
GROUP BY DATE(trade_time);
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 대손실 발생

```
1. 종목 매수 (10,000원, 10주)
2. -8% 손실 발생 → 매도 (9,200원)
3. 예상 결과:
   - 🚨 대손실 -8.00% 발생!
   - 🚫 단일 거래 대손실로 당일 진입 금지
   - 🔒 쿨다운 활성화
   - data/cooldown.lock 생성
```

### 시나리오 2: 연속 중손실

```
1. 1회 거래: -4% 손실
2. 2회 거래: -3.5% 손실
3. 예상 결과:
   - 🚨 2회 연속 중손실!
   - 🚫 2회 연속 -3% 이상 손실로 당일 진입 금지
   - 🔒 쿨다운 활성화
```

---

## 🔄 롤백 방법

만약 문제 발생 시:

```bash
# Git으로 이전 버전 복구
cd /home/greatbps/projects/kiwoom_trading
git diff main_auto_trading.py

# 특정 부분만 복구
git checkout HEAD -- main_auto_trading.py
```

---

## 📊 성과 추적

### Week 1 목표 (2025-11-28 ~ 12-04)

```
현재 성과 (11-14 ~ 11-28):
- 승률: 25.0%
- 평균 손익: -36원/건
- 총 손익: -3,420원

Week 1 목표:
- 승률: 35-40%
- 평균 손익: 0원 이상
- 총 손익: 흑자 전환

핵심 지표:
✓ 대손실 (-5% 이상) 발생 건수: 0건
✓ 연속 중손실 발생 건수: 0건
✓ 금지 종목 평균: 1-2개/일
```

---

## 📝 변경 로그

### 2025-11-28

**추가**:
- 일일 -5% 이상 대손실 즉시 금지
- 2회 연속 -3% 이상 중손실 금지
- 손실률 및 금지 사유를 쿨다운 파일에 기록

**개선**:
- 금지 조건 3단계 체계화
- 콘솔 메시지 강화 (손실률 표시)
- 쿨다운 파일에 loss_rate, reason 추가

**유지**:
- 3회 연속 손실 금지 (기존 로직)
- 쿨다운 20분 (기존 설정)
- 프로세스 간 동기화 (기존 구현)

---

**최종 검증**: ✅ 문법 검증 통과 (py_compile)
**적용 상태**: ✅ 코드 수정 완료
**재시작 필요**: ⚠️ 프로세스 재시작 시 적용됨

**다음 단계**: 실거래 모니터링 및 효과 측정
