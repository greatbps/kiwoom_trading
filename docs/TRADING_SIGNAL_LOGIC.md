# 매매 시그널 발생 로직 설명

## 📊 전체 흐름

```
조건검색 (HTS)
    ↓
1차 필터링 (종목 리스트업)
    ↓
2차 필터링 (통합 분석 70점 이상)
    ↓
매매 시그널 생성 ← 여기!
    ↓
자동 매수/매도 실행
```

---

## 🎯 1. 매수 시그널 (BUY/STRONG_BUY)

### 📋 시그널 판단 기준

```python
# 점수에 따른 시그널
final_score >= 70  →  STRONG_BUY (적극 매수)
final_score >= 60  →  BUY (매수)
final_score >= 50  →  HOLD (관망)
final_score >= 40  →  SELL (매도)
final_score <  40  →  STRONG_SELL (적극 매도)
```

### 🔍 추가 조건 체크

```python
if STRONG_BUY or BUY:
    # 1. 기술적 분석 확인
    if 기술적 점수 < 50:
        → ⚠️ "기술적 분석 약세 - 진입 주의"

    # 2. 수급 분석 확인
    if 수급 점수 < 45:
        → ⚠️ "수급 약세 - 진입 주의"

    # 3. 전 영역 강세 확인
    if 모든 분석 점수 >= 60:
        → ✅ "전 영역 강세 - 강력 추천"
```

### 💰 포지션 사이징

```python
# STRONG_BUY (70점 이상)
entry_ratio = 1.0  # 100% 진입
confidence = HIGH

# BUY (60-69점)
entry_ratio = 0.7  # 70% 진입
confidence = MEDIUM
```

---

## 🎯 2. 목표가 계산

### 📐 3단계 목표가 설정

```python
# 우선순위:
1. ATR (Average True Range) 기반
   - 1차 목표: 현재가 + (ATR × 1.5)
   - 2차 목표: 현재가 + (ATR × 2.5)
   - 3차 목표: 현재가 + (ATR × 4.0)

2. 저항선 기반
   - 최근 60일 고가 중 상위 10개
   - 현재가보다 높은 것만 선택

3. 볼린저 밴드 상단
   - 20일 이동평균 + (2 × 표준편차)
```

### 📊 분할 매도 계획

```python
# 1차 목표 (30% 매도)
quantity × 0.3  →  일부 수익 실현

# 2차 목표 (40% 매도)
quantity × 0.4  →  추가 수익 실현

# 3차 목표 (30% 매도)
quantity × 0.3  →  잔량 청산
```

---

## 🛡️ 3. 손절가 계산

### 📐 손절가 결정 방법

```python
# 우선순위:
1. ATR 기반
   stop_loss = 현재가 - (ATR × 2.0)

2. 지지선 기반
   stop_loss = 가장 가까운 지지선 × 0.98

3. 최근 저점 기반
   stop_loss = 최근 20일 저점 × 0.98

# 제한:
최대 손실: -10% (0.90 × 현재가)
최소 손실: -3%  (0.97 × 현재가)
기본값:   -5%  (0.95 × 현재가)
```

---

## 💵 4. 포지션 사이징 (리스크 관리)

### 📊 계산 공식

```python
# 1. 리스크 금액 계산
risk_amount = 계좌잔고 × 2%  # 거래당 2% 리스크

# 2. 주당 리스크
risk_per_share = |현재가 - 손절가|

# 3. 리스크 기반 수량
risk_based_qty = risk_amount ÷ risk_per_share

# 4. 최대 포지션 기반 수량
max_investment = 계좌잔고 × 30%  # 최대 30%
max_qty = max_investment ÷ 현재가

# 5. 최종 수량
optimal_qty = min(risk_based_qty, max_qty)
final_qty = optimal_qty × entry_ratio
```

### 💡 예시

```python
계좌잔고:     10,000,000원
현재가:       10,000원
손절가:       9,500원
entry_ratio:  1.0 (STRONG_BUY)

# 계산:
risk_amount = 10,000,000 × 0.02 = 200,000원
risk_per_share = 10,000 - 9,500 = 500원
risk_based_qty = 200,000 ÷ 500 = 400주

max_investment = 10,000,000 × 0.30 = 3,000,000원
max_qty = 3,000,000 ÷ 10,000 = 300주

# 최종
optimal_qty = min(400, 300) = 300주
final_qty = 300 × 1.0 = 300주

투자금액 = 300 × 10,000 = 3,000,000원 (30%)
```

---

## ⚖️ 5. 리스크/리워드 비율

### 📐 계산 방법

```python
potential_profit = 목표가 - 현재가
potential_loss = 현재가 - 손절가

risk_reward_ratio = potential_profit ÷ potential_loss

# 최소 기준: 1:2 (리스크 1에 리워드 2)
if risk_reward_ratio >= 2.0:
    → ✅ "리스크/리워드 양호"
else:
    → ⚠️ "리스크/리워드 낮음 - 신중"
```

### 💡 예시

```python
현재가:   10,000원
1차 목표: 11,500원  (+15%)
손절가:   9,500원   (-5%)

potential_profit = 11,500 - 10,000 = 1,500원
potential_loss = 10,000 - 9,500 = 500원

risk_reward_ratio = 1,500 ÷ 500 = 3.0

✅ 리스크/리워드 비율 3:1 (양호!)
```

---

## 🎯 6. 매도 시그널 (SELL/STRONG_SELL)

### 📋 시그널 조건

```python
# 자동 매도 트리거:

1. 목표가 도달
   - 1차 목표: 30% 매도
   - 2차 목표: 40% 매도
   - 3차 목표: 30% 매도 (잔량 청산)

2. 손절가 도달
   - 100% 즉시 청산

3. 분석 점수 하락
   - final_score < 40: SELL (50% 청산)
   - final_score < 30: STRONG_SELL (100% 청산)

4. 기술적 이탈
   - 주요 지지선 이탈
   - 이동평균선 데드크로스
```

---

## 🔄 7. 분할 매수 전략

### 📊 점수별 전략

```python
# 70점 이상 + 기술적 60점 이상
→ "전량 1회 매수"
  ratio = [1.0]

# 60-69점
→ "60% + 40% 분할 매수"
  ratio = [0.6, 0.4]
  # 첫 매수 후 조정 시 나머지 매수

# 60점 미만
→ "진입 보류"
  ratio = [0]
```

---

## 📝 8. 실제 매매 플로우

```
1. 조건검색 (HTS)
   ↓
   ["001440", "005070", "005690", ...]

2. 통합 분석 (병렬 처리)
   ↓
   final_score = 76.73 (코스모신소재)

3. 매수 시그널 생성
   ↓
   signal = STRONG_BUY
   entry_ratio = 1.0
   confidence = HIGH

4. 목표가/손절가 계산
   ↓
   현재가: 10,000원
   1차 목표: 11,500원 (ATR 1.5배)
   2차 목표: 12,500원 (ATR 2.5배)
   3차 목표: 14,000원 (ATR 4.0배)
   손절가: 9,500원 (ATR 2배)

5. 포지션 사이징
   ↓
   계좌: 10,000,000원
   수량: 300주
   투자: 3,000,000원 (30%)

6. 리스크/리워드 확인
   ↓
   risk_reward_ratio = 3.0
   ✅ "리스크/리워드 양호"

7. 매수 주문 실행
   ↓
   코스모신소재 300주 @ 10,000원

8. 매도 대기 (3단계)
   ↓
   11,500원: 90주 매도  (30%)
   12,500원: 120주 매도 (40%)
   14,000원: 90주 매도  (30%)

   손절: 9,500원 이하 → 전량 청산
```

---

## 🎛️ 9. 주요 파라미터

```python
# TradingStrategy 초기화
risk_per_trade = 0.02        # 거래당 리스크 2%
max_position_size = 0.30     # 최대 포지션 30%

# 진입 임계값
strong_buy = 70점
buy = 60점
hold = 50점
sell = 40점
strong_sell = 30점

# 리스크/리워드
min_risk_reward_ratio = 2.0  # 최소 1:2

# ATR 기반 목표가
target1 = ATR × 1.5
target2 = ATR × 2.5
target3 = ATR × 4.0

# ATR 기반 손절가
stop_loss = ATR × 2.0 (아래)
```

---

## ✅ 10. 핵심 포인트

1. **2단계 필터링**
   - 1차: HTS 조건검색 (기술적 조건)
   - 2차: 통합 분석 70점 이상 (뉴스+기술+수급+기본)

2. **리스크 우선 관리**
   - 거래당 최대 2% 리스크
   - 최대 포지션 30% 제한
   - 일일 손실 -5% 또는 주간 손실 -3% 도달 시 신규 진입 중단
   - 연속 손실 3건 발생 시 1거래일 쿨다운 및 강화된 사전 검증 적용
   - 손절가 필수 설정

3. **분할 매도**
   - 3단계 목표가로 수익 실현
   - 일부는 큰 상승 노려서 보유

4. **리스크/리워드 비율**
   - 최소 1:2 이상
   - 리스크보다 리워드가 2배 이상일 때만 진입

5. **자동화**
   - 조건검색 → 분석 → 시그널 → 주문 (자동)
   - 목표가/손절가 도달 → 매도 (자동)

---

**작성일**: 2025-10-25
**최종 수정**: 2025-10-25
