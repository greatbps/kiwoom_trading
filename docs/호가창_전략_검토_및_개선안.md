# 호가창 전략 검토 및 개선안

## 📊 GPT 분석 요약

### 1월 2일 실제 성과
- **총 6 트레이드**
- **승률 50%** (3승 3패)
- **평균 수익 +0.96%**
- **최대 수익 +12.22%** (제주반도체)
- **평균 손실 -2.87%**

### GPT의 핵심 주장
> "호가창 필터를 추가하면 손실 거래 2-3건을 사전에 차단 가능"
> "예상 승률: 50% → 75%"
> "예상 평균 수익: +0.96% → +3.34%"

---

## ✅ 긍정적 평가

### 1. 정확한 문제 진단
```
✅ 그래피(1차) -3.89%
   → "오전 급등 후 눌림 아닌 추격"
   → 맞는 진단! 체결 지속성 약했을 가능성 높음

✅ 라온테크 -2.53%
   → "11시 전후 체결 둔화 구간"
   → 정확! VWAP 이탈 후 버팀

✅ 삼보모터스 -2.20%
   → "저가주 특성상 허매수 잦음"
   → 맞음! 체결 밀도 약한 진입
```

### 2. 논리적인 호가창 지표 제안
```
✅ 매도 1-3호가 잔량 감소 (체결 임박)
✅ 동일 가격 체결 3초 지속 (진짜 수요)
✅ 체결강도 120% 이상 (매수세 우위)
✅ 매도호가 급증 시 진입 금지 (물량 출현)
```

### 3. 실전 가능한 로직
```
진입: 방향(스퀴즈) + 타이밍(호가)
손절: VWAP -0.4% or 체결강도 80% 붕괴
익절: 고점 갱신 실패 + 체결 둔화
쿨다운: 손절 후 30분 금지
```

---

## ⚠️ 비판적 검토

### 1. 과도한 낙관 (Overfitting 위험)
```
❌ 문제:
   "호가 필터로 손실 2건 제거 → 승률 75%"
   → 이건 백미러 보며 운전하는 것

🔍 현실:
   - 1월 2일 단 1일 데이터
   - 과거 데이터에 최적화된 필터는 미래에 작동 안 함
   - 최소 100+ 트레이드 검증 필요
```

### 2. 체결강도 120% 기준의 모호함
```
❌ 문제:
   체결강도 = (매수 체결량 / 매도 체결량) × 100

   하지만:
   - 저가주는 체결강도 변동성 극심
   - 우량주는 100% 근처 유지
   - 종목별 특성 고려 안 됨

💡 개선안:
   - 종목별 최근 20일 평균 대비 상대값 사용
   - 예: 현재 120% > 20일 평균 110% → OK
```

### 3. "매도호가 얇음" 조건의 함정
```
❌ 위험:
   매도호가 얇다 = 급등 가능성
   BUT
   매도호가 얇다 = 유동성 부족 → 급락 위험도 높음

💡 개선안:
   "매도호가 감소 추세" 확인
   - 직전 30초 평균보다 60% 감소 (GPT 제안)
   + 최근 5초 연속 감소 중 (추가 조건)
```

### 4. VWAP -0.4% 손절의 타이트함
```
❌ 문제:
   VWAP는 변동성 있음
   -0.4% 손절 → 잦은 흔들림 손절 가능

📊 실제 1월 2일 데이터 확인 필요:
   - 제주반도체: VWAP 대비 최대 이탈폭은?
   - 엘케이켐: 중간에 -0.4% 터치했나?

💡 개선안:
   - ATR 기반 손절: VWAP - (ATR × 0.5)
   - 또는 -0.6% ~ -0.8%로 완화
```

### 5. 쿨다운 30분의 기회비용
```
❌ 문제:
   손절 후 30분 금지
   → 재진입 기회 상실

   예: 그래피
   - 10:35 손절 (-3.89%)
   - 11:45 재진입 (+0.90%)
   → 쿨다운 있었으면 재진입 불가!

💡 개선안:
   - 쿨다운 15분으로 단축
   - 또는 신호 강도별 차등 적용
     (약한 신호 손절 → 30분
      강한 신호 손절 → 15분)
```

---

## 📈 데이터 기반 검증 필요

### 즉시 확인해야 할 것들

#### 1. 체결 데이터 확인
```python
# 1월 2일 각 거래의 체결 패턴 분석
- 그래피 10:15: 진입 전 5분간 체결강도는?
- 라온테크 10:02: 매도호가 감소 추세였나?
- 삼보모터스 11:45: 동일가 체결 3초 지속했나?

→ 이 데이터 없이는 호가 전략 검증 불가!
```

#### 2. VWAP 이탈폭 분석
```python
# 수익 거래의 중간 이탈
제주반도체: VWAP 대비 최저점 -X%?
엘케이켐: VWAP 대비 최저점 -X%?

→ -0.4% 손절 적용 시 흔들림 손절 발생했을까?
```

#### 3. 호가창 데이터 가용성
```
⚠️ 중요: 키움 API에서 제공하는 호가 데이터
1. 실시간 호가 10호가 (가능)
2. 호가 잔량 변화 추적 (가능)
3. 체결강도 실시간 계산 (가능)
4. "직전 30초 평균" 계산 (구현 필요)

→ 기술적으로 구현 가능한지 확인 필요
```

---

## 🎯 현실적인 개선안

### Phase 1: 보수적 호가 필터 (즉시 적용 가능)

#### 진입 조건 추가
```python
# 기존: Squeeze Bright Green + VWAP 위
# 추가:
1. 거래량 ≥ 직전 5분 평균 × 1.3
   → 급격한 거래량 증가 확인

2. 매도 1호가 잔량 < 직전 1분 평균 × 0.8
   → 매도 물량 감소 확인

3. 체결 가격 정체 < 5초
   → 같은 가격에 5초 이상 머물면 SKIP
   (매수세 약함)
```

#### 진입 금지 조건
```python
1. 급등 후 고점 대비 -2% 이상 하락 시
   → 추격 진입 방지

2. 매도호가 총합 급증 (+30% 이상)
   → 대량 물량 출현 회피

3. 직전 1분 체결강도 < 90%
   → 매도 우위 진입 차단
```

### Phase 2: 공격적 호가 필터 (검증 후 적용)

#### 진입 강화
```python
# GPT 제안 + 개선
1. 체결강도 ≥ 자체 20일 평균 × 1.1
   (종목별 특성 반영)

2. 매도 1-3호가 잔량 감소 추세
   (30초간 연속 감소)

3. 동일가 체결 3초 이상 지속
   + 체결량 증가 추세
```

#### 손절 정교화
```python
# VWAP -0.4% → ATR 기반으로 변경
손절 = VWAP - (ATR_14 × 0.5)

# 또는 듀얼 손절
- 급락 손절: VWAP -0.8%
- 추세 손절: 5분 VWAP 이탈 + 체결강도 < 80%
```

#### 익절 다단계
```python
1단계: +2% 도달 → 30% 익절
2단계: +4% 도달 → 추가 30% 익절
3단계: 트레일링 스탑 1.5%
```

---

## 💡 핵심 통찰 (GPT vs 내 의견)

### GPT의 주장: ✅ 방향은 맞다
```
"스퀴즈는 방향, 호가는 타이밍"
→ 100% 동의!

호가 결합으로 승률 향상 가능
→ 맞지만, 75%는 과장
→ 현실적 목표: 55-60%
```

### 내 의견: ⚠️ 단계적 접근 필요
```
1. 먼저 기존 전략 100+ 트레이드 데이터 수집
   → 손실 패턴 통계 분석

2. 호가 데이터 수집 인프라 구축
   → 실시간 체결강도, 호가 변화 추적

3. 보수적 필터 먼저 적용 (Phase 1)
   → 큰 손실만 차단 (승률 50% → 55%)

4. 데이터 축적 후 공격적 필터 (Phase 2)
   → 작은 손실까지 차단 (승률 55% → 60%)

5. 지속적 모니터링 및 조정
   → Overfitting 방지
```

---

## 🔧 즉시 구현 가능한 코드 레벨 제안

### 1. 진입 필터 함수 추가
```python
def check_order_book_entry(stock_code: str, current_price: float) -> Tuple[bool, str]:
    """
    호가창 기반 진입 필터

    Returns:
        (pass, reason)
    """
    # 1. 거래량 체크
    recent_volume = get_recent_volume(stock_code, minutes=5)
    avg_volume = get_average_volume(stock_code, minutes=5, offset=5)

    if recent_volume < avg_volume * 1.3:
        return False, "거래량 부족 (5분 평균 대비 1.3배 미만)"

    # 2. 매도 1호가 잔량 체크
    sell_1st_now = get_sell_order_quantity(stock_code, level=1)
    sell_1st_avg = get_sell_order_avg(stock_code, level=1, seconds=60)

    if sell_1st_now > sell_1st_avg * 0.8:
        return False, "매도 1호가 잔량 과다 (1분 평균 대비)"

    # 3. 가격 정체 체크
    price_stable_time = get_price_stable_duration(stock_code)
    if price_stable_time > 5:
        return False, f"가격 정체 {price_stable_time}초 (매수세 약함)"

    # 4. 급등 후 추격 방지
    high_5min = get_high_price(stock_code, minutes=5)
    if current_price < high_5min * 0.98:
        return False, "급등 후 2% 이상 하락 (추격 진입 방지)"

    return True, "호가창 진입 조건 충족"
```

### 2. 손절 조건 강화
```python
def check_exit_conditions(position: Dict, current_data: Dict) -> Tuple[bool, str]:
    """
    기존 스퀴즈 + 호가창 손절 조건
    """
    # 기존 스퀴즈 손절
    if current_data['sqz_color'] in ['dark_red', 'bright_red']:
        return True, "스퀴즈 Red 전환"

    # VWAP 손절 (ATR 기반)
    vwap = current_data['vwap']
    atr = current_data['atr_14']
    stop_loss = vwap - (atr * 0.5)

    if current_data['current_price'] < stop_loss:
        return True, f"VWAP-ATR 손절 (손절가: {stop_loss:.0f})"

    # 체결강도 붕괴
    if current_data['execution_strength'] < 80:
        return True, "체결강도 80% 붕괴"

    return False, ""
```

---

## 📋 최종 평가

### GPT 제안의 점수
| 항목 | 점수 | 평가 |
|------|------|------|
| 문제 진단 | 9/10 | 손실 거래 분석 정확 |
| 호가 지표 선택 | 8/10 | 실전 가능한 지표 |
| 기대 효과 | 5/10 | 75% 승률은 과장 |
| 구현 가능성 | 7/10 | API 제약 고려 필요 |
| 백테스트 필요성 | 10/10 | 100+ 트레이드 검증 필수 |

**종합 점수: 7.8/10**

### 최종 결론
```
✅ 호가창 전략은 명백히 도움이 됨
✅ 하지만 75% 승률은 비현실적
✅ 현실적 목표: 승률 50% → 55-60%

🎯 추천 접근:
1. Phase 1 보수적 필터 먼저 적용
2. 100+ 트레이드 데이터 수집
3. 실제 성과 검증 후 Phase 2 적용
4. 지속적 모니터링 및 파라미터 조정

⚠️ 주의사항:
- Overfitting 경계
- 1일 데이터로 결론 금지
- 구현 전 호가 데이터 수집 인프라 확인
```

---

## 🚀 Next Steps

### 1주차: 데이터 수집 인프라
```
□ 실시간 호가 10호가 수집
□ 체결강도 실시간 계산
□ 매도호가 변화 추적 (30초 윈도우)
□ 거래량 프로파일 구축
```

### 2주차: Phase 1 구현
```
□ 보수적 진입 필터 3개 추가
□ VWAP-ATR 손절 구현
□ 체결강도 붕괴 감지
```

### 3-4주차: 백테스트 및 검증
```
□ 100+ 트레이드 수집
□ 필터 효과 통계 분석
□ 파라미터 최적화
```

### 5주차 이후: Phase 2 적용
```
□ 공격적 필터 추가
□ 다단계 익절 구현
□ 쿨다운 로직 정교화
```
