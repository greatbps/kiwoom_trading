# íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ë²„ê·¸ ìˆ˜ì • ë¦¬í¬íŠ¸

**ì‘ì„±ì¼**: 2025-12-29
**ë²„ê·¸ ë°œê²¬**: ì˜¨ì½”ë‹‰í…Œë¼í“¨í‹±ìŠ¤ (476060) íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ë¯¸ì‘ë™
**ìˆ˜ì • ë°©ë²•**: Option 1 (ë©”ëª¨ë¦¬ ìƒíƒœ ë³´ì¡´)

---

## ğŸš¨ ë°œê²¬ëœ ë¬¸ì œ

### ì¦ìƒ
- ì£¼ê°€ê°€ ìµœê³  +12.59% (23,700ì›)ê¹Œì§€ ìƒìŠ¹
- í˜„ì¬ +8.31% (22,800ì›)ìœ¼ë¡œ í•˜ë½
- **íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ì´ ë°œë™í•˜ì§€ ì•ŠìŒ** (ì˜ˆìƒ: +11.70%ì—ì„œ ì²­ì‚°)
- ì•½ 3.39% (710ì›) ì¶”ê°€ ì´ìµ ì†ì‹¤

### ê·¼ë³¸ ì›ì¸

**Position ìƒíƒœ ì†ì‹¤ ë¬¸ì œ**:

```python
# main_auto_trading.py:980 (initialize_account)
self.positions[stock_code] = {
    'stock_name': stock_name,
    'quantity': quantity,
    'avg_price': avg_price,
    # ... ê¸°ë³¸ í•„ë“œë§Œ ìƒì„±
}
# âŒ ë¬¸ì œ: highest_price, trailing_active ë“± íŠ¸ë ˆì¼ë§ ìƒíƒœ ëˆ„ë½!
```

**ì‹œí€€ìŠ¤**:
1. `check_exit_signal()` í˜¸ì¶œ â†’ position['highest_price'] ì—…ë°ì´íŠ¸
2. ê³„ì¢Œ ì •ë³´ ê°±ì‹  ì‹œ `initialize_account()` ì‹¤í–‰
3. `self.positions[stock_code]` ì™„ì „íˆ ìƒˆ dictë¡œ êµì²´
4. **íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ëª¨ë‘ ì†ì‹¤!**

---

## âœ… ì ìš©ëœ ìˆ˜ì •ì‚¬í•­

### 1. Position ì´ˆê¸°í™” ì‹œ ìƒíƒœ ë³´ì¡´

**íŒŒì¼**: `main_auto_trading.py`
**ìœ„ì¹˜**: Line 980-998

```python
# ğŸ”§ FIX: ê¸°ì¡´ íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ë³´ì¡´
existing_position = self.positions.get(stock_code, {})

self.positions[stock_code] = {
    'stock_name': stock_name,
    'name': stock_name,
    'quantity': quantity,
    'avg_price': avg_price,
    'entry_price': avg_price,
    'current_price': current_price,
    'profit_rate': profit_rate,
    'eval_amount': quantity * current_price,
    'entry_date': entry_date,
    # ğŸ”§ FIX: íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ë³´ì¡´
    'highest_price': existing_position.get('highest_price', avg_price),
    'trailing_active': existing_position.get('trailing_active', False),
    'trailing_stop_price': existing_position.get('trailing_stop_price'),
    'partial_exit_stage': existing_position.get('partial_exit_stage', 0)
}
```

**íš¨ê³¼**:
- ê³„ì¢Œ ì •ë³´ ê°±ì‹  ì‹œì—ë„ íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ìœ ì§€
- `highest_price`, `trailing_active`, `trailing_stop_price`, `partial_exit_stage` ë³´ì¡´

---

### 2. íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ë¡œê¹… ì¶”ê°€

**íŒŒì¼**: `main_auto_trading.py`
**ìœ„ì¹˜**: Line 3151-3159

```python
# ğŸ”§ FIX: íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ë¡œê·¸ ì¶”ê°€
trailing_status = ""
if position.get('trailing_active'):
    highest = position.get('highest_price', 0)
    stop_price = position.get('trailing_stop_price', 0)
    max_profit = ((highest - position['entry_price']) / position['entry_price']) * 100
    trailing_status = f" | íŠ¸ë ˆì¼ë§í™œì„± (ìµœê³ :{highest:,.0f}ì› +{max_profit:.2f}%, ìŠ¤íƒ‘:{stop_price:,.0f}ì›)"

console.print(f"[dim]  ğŸ’° {stock_code}: í˜„ì¬ê°€ {current_price:,.0f}ì›, ì§„ì…ê°€ {position['entry_price']:,.0f}ì›, ìˆ˜ìµë¥  {profit_pct:+.2f}%{trailing_status}[/dim]")
```

**íš¨ê³¼**:
- íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ í™œì„±í™” ì‹œ ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ
- ìµœê³ ê°€, íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ë¼ì¸ í™•ì¸ ê°€ëŠ¥
- ë””ë²„ê¹… ë° ëª¨ë‹ˆí„°ë§ ìš©ì´

---

## ğŸ“Š ì˜ˆìƒ íš¨ê³¼ (ì‹œë®¬ë ˆì´ì…˜)

### ì˜¨ì½”ë‹‰í…Œë¼í“¨í‹±ìŠ¤ ì¼€ì´ìŠ¤

**ìˆ˜ì • ì „** (ì‹¤ì œ ë°œìƒ):
```
09:00  ë§¤ìˆ˜     21,050ì›
10:30  ìƒìŠ¹     23,700ì›  (+12.59%)  â† íŠ¸ë ˆì¼ë§ í™œì„±í™” ë˜ì–´ì•¼ í•¨
11:00  í•˜ë½     22,800ì›  (+8.31%)   â† ì—¬ì „íˆ ë³´ìœ  ì¤‘
       ê²°ê³¼: ì•½ -3.39% ì†ì‹¤ (710ì›)
```

**ìˆ˜ì • í›„** (ì˜ˆìƒ ë™ì‘):
```
09:00  ë§¤ìˆ˜     21,050ì›
09:15  +2.5%    21,576ì›  â†’ íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ í™œì„±í™” âœ…
10:30  ìµœê³      23,700ì›  (+12.59%)
       â†’ highest_price = 23,700
       â†’ trailing_stop = 23,510 (23,700 Ã— 0.992)
11:00  í•˜ë½     22,800ì›
       â†’ 22,800 < 23,510 â†’ íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ë°œë™! âœ…
       â†’ 23,510ì›ì— ì²­ì‚° (+11.70%)

       ê²°ê³¼: +11.70% ìˆ˜ìµ í™•ë³´ (ìµœê³  ëŒ€ë¹„ -0.80% ì†ì‹¤)
```

**ê°œì„  íš¨ê³¼**:
- ìˆ˜ìµ ë³´ì¡´: +8.31% â†’ +11.70% (+3.39%)
- ì†ì‹¤ ìµœì†Œí™”: ìµœê³ ê°€ ëŒ€ë¹„ -3.80% â†’ -0.80%

---

## ğŸ” ê²€ì¦ ë°©ë²•

### 1. ë¡œê·¸ í™•ì¸

ë‹¤ìŒ ê±°ë˜ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ê°€ í‘œì‹œë˜ì–´ì•¼ í•¨:

```
ğŸ’° 476060: í˜„ì¬ê°€ 23,700ì›, ì§„ì…ê°€ 21,050ì›, ìˆ˜ìµë¥  +12.59%
   â†“ (ê°€ê²© í•˜ë½)
ğŸ’° 476060: í˜„ì¬ê°€ 22,800ì›, ì§„ì…ê°€ 21,050ì›, ìˆ˜ìµë¥  +8.31% | íŠ¸ë ˆì¼ë§í™œì„± (ìµœê³ :23,700ì› +12.59%, ìŠ¤íƒ‘:23,510ì›)
   â†“
ATR íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ (+8.31%) â† ì²­ì‚° ì‹¤í–‰!
```

### 2. Position State í™•ì¸

Python ì½˜ì†”ì—ì„œ:
```python
# ì‹œìŠ¤í…œ ì‹¤í–‰ ì¤‘
>>> self.positions['476060']
{
    'highest_price': 23700,
    'trailing_active': True,
    'trailing_stop_price': 23510,
    'entry_price': 21050,
    ...
}
```

### 3. ì‹¤ì „ í…ŒìŠ¤íŠ¸

- ë‹¤ìŒ ê±°ë˜ì¼ ì‹¤ì œ ì£¼ê°€ ì›€ì§ì„ì—ì„œ ê²€ì¦
- 2.5% ì´ìƒ ìˆ˜ìµ ë°œìƒ ì‹œ íŠ¸ë ˆì¼ë§ í™œì„±í™” í™•ì¸
- ê³ ê°€ ëŒ€ë¹„ 0.8% í•˜ë½ ì‹œ ìë™ ì²­ì‚° í™•ì¸

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Position ì´ˆê¸°í™” ì‹œ ìƒíƒœ ë³´ì¡´ êµ¬í˜„
- [x] íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ìƒíƒœ ë¡œê¹… ì¶”ê°€
- [x] ê¸°ì¡´ execute_buy ì½”ë“œ í™•ì¸ (ì´ë¯¸ í•„ë“œ í¬í•¨ë¨)
- [ ] ì‹¤ì „ ê±°ë˜ì—ì„œ íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ì‘ë™ ê²€ì¦
- [ ] ì£¼ê°„ ê±°ë˜ ë¶„ì„ ì‹œ íŠ¸ë ˆì¼ë§ íš¨ê³¼ ì¸¡ì •

---

## ğŸ¯ ê²°ë¡ 

**ê·¼ë³¸ ì›ì¸**: ê³„ì¢Œ ì •ë³´ ê°±ì‹  ì‹œ position dictionaryê°€ ì™„ì „íˆ êµì²´ë˜ë©´ì„œ íŠ¸ë ˆì¼ë§ ìƒíƒœ ì†ì‹¤

**ì ìš© ì†”ë£¨ì…˜**: Position ì¬ìƒì„± ì‹œ ê¸°ì¡´ ìƒíƒœ ë³´ì¡´ (Option 1)

**ì˜ˆìƒ ê°œì„ **:
- íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ì •ìƒ ì‘ë™
- ìˆ˜ìµ ìµœëŒ€ ë³´ì¡´ (ê³ ê°€ ëŒ€ë¹„ -0.8% ì†ì‹¤ë¡œ ì œí•œ)
- ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥

**ë‹¤ìŒ ë‹¨ê³„**:
- ì‹¤ì „ ê±°ë˜ì—ì„œ ê²€ì¦
- í•„ìš” ì‹œ DB ì˜ì†í™” ì¶”ê°€ (í–¥í›„ Option 1+ ê³ ë„í™”)
