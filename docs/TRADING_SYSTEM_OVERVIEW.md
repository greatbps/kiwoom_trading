# 키움 자동매매 시스템 전체 개요

**작성일**: 2025-12-23
**시스템 버전**: v2.0 (Bottom Pullback 전략 통합)

---

## 1. 시스템 아키텍처

### 핵심 구성요소

```
┌─────────────────────────────────────────────────────────────┐
│                   키움 OpenAPI 연결                         │
│              (WebSocket + REST API)                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
    ┌─────────────┴──────────────┐
    │                            │
┌───▼────────────┐    ┌──────────▼──────────┐
│  조건검색 (7개) │    │  실시간 데이터      │
│  Condition     │    │  Real-time Data     │
│  Search        │    │  Streaming          │
└───┬────────────┘    └──────────┬──────────┘
    │                            │
    │         ┌──────────────────┴──────┐
    │         │                         │
┌───▼─────────▼───────┐     ┌──────────▼──────────┐
│  SignalOrchestrator │     │  BottomPullback     │
│  (L0-L6 Filtering)  │     │  Manager            │
└───┬─────────────────┘     └──────────┬──────────┘
    │                                  │
    ├──────────────┬───────────────────┤
    │              │                   │
┌───▼──────┐  ┌───▼────┐  ┌──────────▼──────┐
│ Momentum │  │ Bottom │  │  Position       │
│ Entry    │  │ Entry  │  │  Manager        │
│ (즉시)   │  │(대기)  │  │                 │
└───┬──────┘  └───┬────┘  └──────────┬──────┘
    │             │                   │
    └─────────────┴───────────────────┘
                  │
         ┌────────▼──────────┐
         │  Exit Manager     │
         │  (청산 관리)      │
         │  - Trailing Stop  │
         │  - Partial Exit   │
         │  - EOD Policy     │
         └───────────────────┘
```

---

## 2. 전략 구성 (7개)

### 2.1 Momentum 전략 (조건 17-22번)

**특징**: 즉시 매수 방식
**조건**:
- 조건검색 신호 발생
- L0-L6 필터 통과
- VWAP 상단 돌파
- 거래량 증가

**진입 방식**:
```
조건 신호 → L0-L6 필터 → watchlist 추가 → 즉시 매수 검토
```

**적용 조건**:
- 17번: 모멘텀 1단계
- 18번: 모멘텀 2단계
- 19번: 모멘텀 3단계
- 20번: 모멘텀 4단계
- 21번: 모멘텀 5단계
- 22번: 모멘텀 6단계

---

### 2.2 Bottom Pullback 전략 (조건 23번) ⭐ 신규

**특징**: 대기 후 진입 방식
**핵심 개념**: 저점 확인 후 재돌파 시 진입

**진입 방식**:
```
조건 신호 → L0-L6 필터 → signal_watchlist 등록
→ Pullback 대기 → VWAP 재돌파 → 매수
```

**상태 머신**:
```
WAIT_PULLBACK (신호 대기)
    ↓ (VWAP 이탈 감지)
PULLBACK_DETECTED (Pullback 확인)
    ↓ (VWAP 재돌파 + 거래량 확인)
READY_TO_ENTER (매수 준비)
    ↓ (매수 실행)
IN_POSITION (포지션 보유)

※ 언제든지 → INVALIDATED (무효화)
```

**무효화 조건**:
- 신호봉 저가 -0.5% 이탈
- 대기 시간 180분 초과
- 진입 시간대 이탈 (09:30-14:30)

**구현 파일**: `trading/bottom_pullback_manager.py`

---

## 3. 필터링 파이프라인 (L0-L6)

**모든 전략 공통 적용**

### L0: 일일 손실 제한
- 일일 손실 한도 도달 시 차단
- Hard stop: -2.0%

### L1: 거래량 필터
- 최소 거래량 배율: 1.5x
- 5일 평균 대비 비교

### L2: 변동성 필터
- ATR 기준: 0.8% ~ 4.0%
- 너무 낮거나 높은 변동성 제외

### L3: 시간대 필터
```python
morning_penalty: 0.5      # 09:30-12:00 가중치 50% 감소
midday_penalty: 0.0       # 12:00-14:00 완전 차단
afternoon_bonus: 1.5      # 14:00-14:59 가중치 50% 증가
```

### L4: RS (Relative Strength) 필터
- IBD식 상대강도 체크
- 최소 RS 요구

### L5: Squeeze 필터
- Bollinger Bands + Keltner Channel
- 변동성 축소 구간 감지

### L6: 리스크 검증
- 승률, Profit Factor, 최대 손실 종합 평가
- Multi-Alpha 점수 체크

---

## 4. 포지션 관리

### 4.1 진입 관리

**포지션 크기 계산**:
```python
position_size = min(
    account_balance * max_position_size_pct,
    account_balance * position_risk_pct / atr_stop,
    hard_max_position
)
```

**제한**:
- 최대 동시 보유: 3개
- 포지션당 최대: 30%
- 하드 제한: 300,000원

### 4.2 청산 관리

**부분 청산**:
- +1.5% 도달: 30% 청산
- +2.5% 도달: 30% 청산
- 나머지 40%: 트레일링 스톱

**트레일링 스톱**:
- 활성화: +2.5% 이상
- 거리: 최고가 대비 -0.8%
- 최소 수익 보장: +0.3%

**손절**:
- 기본 손절: -3.0%
- 기술적 손절: -1.5%
- 초기 실패 컷 (30분 이내): -1.6%

**EOD (End of Day) 정책**:
- 14:55 체크 시작
- 15:05 강제 청산
- 익일 보유 최대 3종목 (점수 0.6 이상)

---

## 5. 스케줄링

### 일일 루틴

```
05:00 ~ 08:50  대기 (적응형 간격)
    - 남은 시간 > 1시간: 1시간마다 체크
    - 10분 ~ 1시간: 10분마다 체크
    - 1분 ~ 10분: 1분마다 체크
    - < 1분: 10초마다 체크

08:50          조건검색 실행 (7개 전략)
08:50 ~ 09:00  L0-L6 필터링
09:00          실시간 모니터링 시작
09:00 ~ 15:30  매매 실행
15:30          장 종료, 익일 08:50까지 대기
```

### 무한 반복

```python
while running:
    await daily_routine()  # 08:50 ~ 15:30
    await wait_until(next_day, 08:50)  # 적응형 대기
```

---

## 6. 데이터 흐름

### 조건검색 → 매수

**Momentum (17-22번)**:
```
조건 신호
  → L0-L6 필터
  → watchlist 추가
  → 실시간 모니터링
  → VWAP/MA20 체크
  → 즉시 매수
```

**Bottom Pullback (23번)**:
```
조건 신호
  → L0-L6 필터
  → signal_watchlist 등록
  → Pullback 모니터링
  → VWAP 이탈 감지
  → VWAP 재돌파 확인
  → 거래량 체크
  → 매수
```

### 실시간 모니터링 → 청산

```
포지션 보유
  → 60초마다 체크
  → 수익률 계산
  → 부분 청산 조건 확인
  → 트레일링 스톱 체크
  → 손절 조건 확인
  → EOD 시간 체크
  → 청산 실행
```

---

## 7. 핵심 설정 파일

### `config/strategy_hybrid.yaml`

**주요 설정**:
```yaml
# 트레일링 스톱
trailing:
  activation_pct: 1.5
  ratio: 1.0
  stop_loss_pct: 3.0
  use_atr_based: true
  atr_multiplier: 1.3

# 리스크 관리
risk_management:
  max_positions: 3
  position_risk_pct: 1.0
  hard_max_position: 300000

# 조건 전략 설정
condition_strategies:
  momentum:
    condition_indices: [17, 18, 19, 20, 21, 22]
    immediate_entry: true

  bottom_pullback:
    condition_indices: [23]
    immediate_entry: false
    wait_for_pullback: true
```

---

## 8. 모니터링 & 로깅

### 로그 파일
- `/tmp/trading_7strategies.log` - 실시간 거래 로그
- `data/weekly_trade_report.json` - 주간 거래 요약

### 실시간 표시
```
┌─────────────────────────────────────────┐
│ 보유 포지션: 1개                        │
│ 모니터링: 4개                           │
├─────────────────────────────────────────┤
│ 종목     현재가  VWAP  MA20  거래량     │
│ 에이치브이엠  52,300   ✓     ✓    +1.3  │
│ 미래에셋벤처  22,450   ✓     ✓    -8.6  │
├─────────────────────────────────────────┤
│ Bottom Pullback 신호: 1개               │
│ 오름테라퓨틱 - WAIT_PULLBACK           │
└─────────────────────────────────────────┘
```

---

## 9. 성능 지표

### 목표
- 일일 목표 수익: +2.0%
- 최대 일일 손실: -2.0%
- 최대 연속 손실: 3회
- 손익비 목표: > 1.5

### 실제 성과 (2025-12-16 기준)
```
12/16: -2,060원 (11건 거래)
12/22: -4,400원 (1건 거래)
현재 보유: 미래에셋벤처투자 +66.29%
```

---

## 10. 주요 개선 사항

### 최근 업데이트 (2025-12-23)

1. **Bottom Pullback 전략 추가** (조건 23번)
   - 대기 후 진입 방식 구현
   - 상태 머신 기반 관리
   - VWAP 재돌파 확인

2. **적응형 대기 간격**
   - 남은 시간에 따라 체크 간격 자동 조정
   - CPU 효율성 향상
   - 사용자 경험 개선

3. **백그라운드 실행 모드**
   - `./run.sh bg` 명령 추가
   - nohup 자동 적용
   - 로그 자동 저장

4. **시간대 필터 강화**
   - 점심시간 완전 차단 (12:00-14:00)
   - 오후 시간대 가중치 증가
   - 조기 실패 컷 30분 연장

---

## 참고 문서

- `BOTTOM_PULLBACK_STRATEGY.md` - Bottom 전략 상세
- `TRADING_FILES_REFERENCE.md` - 핵심 파일 설명
- `WEEKLY_TRADE_SUMMARY_*.md` - 주간 거래 분석
