# ì‹¤ê³„ì¢Œ ì—°ë™ ì™„ë£Œ ë³´ê³ ì„œ (ìµœì¢…)

**ì‘ì„±ì¼:** 2025-10-26 15:45
**ì†Œìš” ì‹œê°„:** ì•½ 2ì‹œê°„
**ìƒíƒœ:** âœ… ì™„ë£Œ ë° ê²€ì¦ ì™„ë£Œ

---

## ğŸ“‹ ì™„ë£Œëœ ì‘ì—…

### 1. í‚¤ì›€ OpenAPI ë¬¸ì„œ ë¶„ì„
**ë¬¸ì œ:** ì¶”ì • ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©ìœ¼ë¡œ 500 ì—ëŸ¬ ë°œìƒ

**í•´ê²°:**
- í‚¤ì›€ ê³µì‹ API ë¬¸ì„œ í™•ì¸
- ì˜¬ë°”ë¥¸ ì—”ë“œí¬ì¸íŠ¸: `/api/dostk/acnt`
- API-ID í—¤ë”ë¡œ ê¸°ëŠ¥ êµ¬ë¶„
  - `kt00001`: ì˜ˆìˆ˜ê¸ˆìƒì„¸í˜„í™©
  - `ka01690`: ì¼ë³„ì”ê³ ìˆ˜ìµë¥ 
  - `ka10074`: ì¼ìë³„ì‹¤í˜„ì†ìµ

---

### 2. `kiwoom_api.py` ìˆ˜ì •

#### 2.1 `get_balance()` - ì˜ˆìˆ˜ê¸ˆ ì¡°íšŒ
**íŒŒì¼:** `kiwoom_api.py:218-268`

```python
def get_balance(self) -> Dict[str, Any]:
    """
    ê³„ì¢Œ ì”ê³  ì¡°íšŒ (ì˜ˆìˆ˜ê¸ˆ ìƒì„¸ í˜„í™©)
    API-ID: kt00001
    """
    endpoint = '/api/dostk/acnt'
    url = f"{self.BASE_URL}{endpoint}"

    headers = {
        'Content-Type': 'application/json;charset=UTF-8',
        'authorization': f'Bearer {self.access_token}',
        'cont-yn': 'N',
        'next-key': '',
        'api-id': 'kt00001',  # ì˜ˆìˆ˜ê¸ˆìƒì„¸í˜„í™©
    }

    data = {
        'qry_tp': '3',  # ì¡°íšŒêµ¬ë¶„: 3=ì¶”ì •ì¡°íšŒ
    }

    response = self.session.post(url, headers=headers, json=data)
    return response.json()
```

**ì‘ë‹µ ì˜ˆì‹œ:**
```json
{
  "entr": "000000000425654",           // ì˜ˆìˆ˜ê¸ˆ
  "ord_alow_amt": "000000000425654",   // ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡
  "pymn_alow_amt": "000000000425654",  // ì¶œê¸ˆê°€ëŠ¥ê¸ˆì•¡
  "return_code": 0,
  "return_msg": "ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

#### 2.2 `get_account_info()` - ë³´ìœ  ì¢…ëª© ì¡°íšŒ
**íŒŒì¼:** `kiwoom_api.py:270-333`

```python
def get_account_info(self) -> Dict[str, Any]:
    """
    ê³„ì¢Œ ë³´ìœ  ì¢…ëª© ì¡°íšŒ (ì¼ë³„ì”ê³ ìˆ˜ìµë¥ )
    API-ID: ka01690
    """
    endpoint = '/api/dostk/acnt'

    headers = {
        'Content-Type': 'application/json;charset=UTF-8',
        'authorization': f'Bearer {self.access_token}',
        'cont-yn': 'N',
        'next-key': '',
        'api-id': 'ka01690',  # ì¼ë³„ì”ê³ ìˆ˜ìµë¥ 
    }

    from datetime import datetime
    today = datetime.now().strftime('%Y%m%d')
    data = {
        'qry_dt': today,
    }

    response = self.session.post(url, headers=headers, json=data)
    return response.json()
```

**ì‘ë‹µ ì˜ˆì‹œ:**
```json
{
  "tot_buy_amt": "0",
  "tot_evlt_amt": "0",
  "tot_evltv_prft": "0",
  "day_bal_rt": [
    {
      "stk_cd": "005930",
      "stk_nm": "ì‚¼ì„±ì „ì",
      "rmnd_qty": "10",
      "cur_prc": "50000",
      "buy_uv": "48000",
      "evltv_prft": "20000",
      "prft_rt": "+4.17"
    }
  ],
  "return_code": 0
}
```

---

### 3. `main_auto_trading.py` ìˆ˜ì •

#### 3.1 `initialize_account()` - ì‘ë‹µ íŒŒì‹±
**íŒŒì¼:** `main_auto_trading.py:213-237`

```python
async def initialize_account(self):
    """ê³„ì¢Œ ì •ë³´ ì´ˆê¸°í™” (ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ)"""

    # 1. ê³„ì¢Œ ì”ê³  ì¡°íšŒ (API-ID: kt00001)
    balance_info = self.api.get_balance()

    # ì˜ˆìˆ˜ê¸ˆ íŒŒì‹± (15ìë¦¬ ë¬¸ìì—´ â†’ ìˆ«ì)
    cash_str = balance_info.get('entr', '000000000000000')
    self.current_cash = float(cash_str)

    # 2. ë³´ìœ  ì¢…ëª© ì¡°íšŒ (API-ID: ka01690)
    account_info = self.api.get_account_info()
    positions = account_info.get('day_bal_rt', [])

    # 3. ë³´ìœ  í¬ì§€ì…˜ í‰ê°€ì•¡ ê³„ì‚°
    self.positions_value = 0.0
    for pos in positions:
        if not pos.get('stk_cd') or pos.get('stk_cd') == '':
            continue

        cur_prc = int(pos.get('cur_prc', 0)) if pos.get('cur_prc') else 0
        rmnd_qty = int(pos.get('rmnd_qty', 0)) if pos.get('rmnd_qty') else 0
        self.positions_value += cur_prc * rmnd_qty

    # 4. ì´ ìì‚°
    self.total_assets = self.current_cash + self.positions_value
```

#### 3.2 ë³´ìœ  í¬ì§€ì…˜ ë¡œë“œ
**íŒŒì¼:** `main_auto_trading.py:253-279`

```python
# 5. ë³´ìœ  í¬ì§€ì…˜ ë¡œë“œ
if positions:
    for pos in positions:
        stock_code = pos.get('stk_cd', '')
        if not stock_code or stock_code == '':
            continue

        stock_name = pos.get('stk_nm', '')
        quantity = int(pos.get('rmnd_qty', 0)) if pos.get('rmnd_qty') else 0
        avg_price = int(pos.get('buy_uv', 0)) if pos.get('buy_uv') else 0
        current_price = int(pos.get('cur_prc', 0)) if pos.get('cur_prc') else 0
        profit_rate = float(pos.get('prft_rt', 0)) if pos.get('prft_rt') else 0.0

        self.positions[stock_code] = {
            'stock_name': stock_name,
            'quantity': quantity,
            'avg_price': avg_price,
            'current_price': current_price,
            'profit_rate': profit_rate,
            'eval_amount': quantity * current_price
        }
```

#### 3.3 `update_account_balance()` - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
**íŒŒì¼:** `main_auto_trading.py:305-334`

```python
async def update_account_balance(self):
    """ê±°ë˜ í›„ ì‹¤ì‹œê°„ ì”ê³  ì—…ë°ì´íŠ¸"""

    # 1. ê³„ì¢Œ ì”ê³  ì¡°íšŒ
    balance_info = self.api.get_balance()
    cash_str = balance_info.get('entr', str(int(self.current_cash)).zfill(15))
    self.current_cash = float(cash_str)

    # 2. ë³´ìœ  ì¢…ëª© ì¡°íšŒ
    account_info = self.api.get_account_info()
    positions = account_info.get('day_bal_rt', [])

    # 3. í¬ì§€ì…˜ í‰ê°€ì•¡ ê³„ì‚°
    self.positions_value = 0.0
    for pos in positions:
        if not pos.get('stk_cd') or pos.get('stk_cd') == '':
            continue

        cur_prc = int(pos.get('cur_prc', 0)) if pos.get('cur_prc') else 0
        rmnd_qty = int(pos.get('rmnd_qty', 0)) if pos.get('rmnd_qty') else 0
        self.positions_value += cur_prc * rmnd_qty

    # 4. ì´ ìì‚°
    self.total_assets = self.current_cash + self.positions_value

    # 5. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì—…ë°ì´íŠ¸
    if self.risk_manager:
        self.risk_manager.update_balance(self.current_cash)
```

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ì‹¤ê³„ì¢Œ ì •ë³´ (2025-10-26 15:45)

```
================================================================================
ì‹¤ê³„ì¢Œ ê¸°ë°˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ í†µí•© í…ŒìŠ¤íŠ¸
================================================================================

[1] í† í° ë°œê¸‰
âœ“ í† í° ë°œê¸‰ ì„±ê³µ

[2] ì˜ˆìˆ˜ê¸ˆ ì¡°íšŒ (API-ID: kt00001)
  ì˜ˆìˆ˜ê¸ˆ: 425,654ì›
  ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡: 425,654ì›

[3] ë³´ìœ  ì¢…ëª© ì¡°íšŒ (API-ID: ka01690)
  ì´ ë§¤ìˆ˜ê¸ˆì•¡: 0ì›
  ì´ í‰ê°€ê¸ˆì•¡: 0ì›
  ì´ í‰ê°€ì†ìµ: 0ì›
  ë³´ìœ  ì¢…ëª© ìˆ˜: 0

[4] ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì´ˆê¸°í™” (ì‹¤ì œ ì”ê³  ê¸°ë°˜)
  ì´ˆê¸° ì”ê³ : 425,654ì›

[5] í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° í…ŒìŠ¤íŠ¸
  í˜„ì¬ê°€: 50,000ì›
  ì†ì ˆê°€: 48,500ì›

  ê³„ì‚° ê²°ê³¼:
  - ìˆ˜ëŸ‰: 2ì£¼
  - íˆ¬ìê¸ˆì•¡: 100,000ì›
  - ë¦¬ìŠ¤í¬ ê¸ˆì•¡: 8,513ì› (8,513ì› = 2%)
  - í¬ì§€ì…˜ ë¹„ìœ¨: 23.49%
  - ìµœëŒ€ ì†ì‹¤: 3,000ì›

[6] ì§„ì… ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  ì´ ìì‚°: 425,654ì›
  í˜„ê¸ˆ ì”ê³ : 425,654ì›
  ë³´ìœ  ì¢…ëª© í‰ê°€: 0ì›
  ê²°ê³¼: âœ“ ì§„ì… ê°€ëŠ¥
  ì‚¬ìœ : OK

[7] ë¦¬ìŠ¤í¬ ì§€í‘œ
  í˜„ê¸ˆ ë¹„ìœ¨: 100.00%
  í¬ì§€ì…˜ ë¹„ìœ¨: 0.00%
  ì¼ì¼ ì‹¤í˜„ ì†ìµ: 0ì›
  ì¼ì¼ ë¯¸ì‹¤í˜„ ì†ìµ: 0ì›
  ì¼ì¼ ì´ ì†ìµ: 0ì›
  ì¼ì¼ ìˆ˜ìµë¥ : 0.00%

================================================================================

âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!

ğŸ“Š ê²°ê³¼:
  - API ì—°ë™: âœ“
  - ì‹¤ê³„ì¢Œ ì¡°íšŒ: âœ“
  - ë¦¬ìŠ¤í¬ ê´€ë¦¬ì: âœ“
  - í¬ì§€ì…˜ ê³„ì‚°: âœ“

ğŸš€ ì›”ìš”ì¼ ì‹¤ì „ íˆ¬ì… ì¤€ë¹„ ì™„ë£Œ!
```

---

## ğŸ¯ ì‹¤í–‰ íë¦„ (ìµœì¢…)

### ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ
```
1. í† í° ë°œê¸‰ âœ“
2. WebSocket ì—°ê²° âœ“
3. ë¡œê·¸ì¸ âœ“
4. ê³„ì¢Œ ì •ë³´ ì¡°íšŒ âœ“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ’° ê³„ì¢Œ í˜„í™©                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ ê³„ì¢Œë²ˆí˜¸: 6259-3479         â”‚
   â”‚ ì˜ˆìˆ˜ê¸ˆ: 425,654ì›           â”‚
   â”‚ ë³´ìœ ì¢…ëª© í‰ê°€: 0ì›          â”‚
   â”‚ ì´ ìì‚°: 425,654ì›          â”‚
   â”‚ ë³´ìœ ì¢…ëª© ìˆ˜: 0ê°œ            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
5. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì´ˆê¸°í™” (ì‹¤ì œ ì”ê³ : 425,654ì›)
6. ì¡°ê±´ê²€ìƒ‰ ì‹œì‘
```

### ë§¤ìˆ˜ ì‹ í˜¸ ë°œìƒ ì‹œ
```
1. ì¢…ëª© ë°œê²¬: 005930 (ì‚¼ì„±ì „ì)
2. VWAP ê²€ì¦ í†µê³¼
3. í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° (ì‹¤ì œ ì”ê³  ê¸°ë°˜)
   - ê°€ìš© í˜„ê¸ˆ: 425,654ì›
   - ë¦¬ìŠ¤í¬ 2%: 8,513ì›
   - ë§¤ìˆ˜ ê¸ˆì•¡: 100,000ì› (23.5%)
   - ë§¤ìˆ˜ ìˆ˜ëŸ‰: 2ì£¼
4. ì§„ì… ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸: âœ“ OK
5. ë§¤ìˆ˜ ì‹¤í–‰
6. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ê¸°ë¡
```

### ë§¤ë„ ì‹ í˜¸ ë°œìƒ ì‹œ
```
1. íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ë„ë‹¬
2. ë§¤ë„ ì‹¤í–‰
3. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ê¸°ë¡
4. ì”ê³  ì—…ë°ì´íŠ¸ âœ“
```

---

## ğŸ“Š Before vs After

### Before (ê°œì„  ì „)
```
ì´ˆê¸° ì”ê³ : 10,000,000ì› (í•˜ë“œì½”ë”©)
ë¦¬ìŠ¤í¬ ê³„ì‚°: ê°€ìƒ ì”ê³  ê¸°ë°˜
í¬ì§€ì…˜ í¬ê¸°: ê³ ì •ê°’ ë˜ëŠ” ë¶€ì •í™•
ê³„ì¢Œ ì—°ë™: âŒ
```

### After (ê°œì„  í›„)
```
ì´ˆê¸° ì”ê³ : 425,654ì› (ì‹¤ê³„ì¢Œ ì¡°íšŒ)
ë¦¬ìŠ¤í¬ ê³„ì‚°: ì‹¤ì œ ì”ê³  ê¸°ë°˜
í¬ì§€ì…˜ í¬ê¸°: ì •í™•í•œ ë¦¬ìŠ¤í¬ 2%, í•œë„ 30%
ê³„ì¢Œ ì—°ë™: âœ…
ì§„ì… ì œí•œ: ì¼ì¼ ì†ì‹¤, ê±°ë˜ íšŸìˆ˜ ìë™ ì²´í¬
ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸: ë§¤ìˆ˜/ë§¤ë„ í›„ ìë™ ê°±ì‹ 
```

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### 1. `kiwoom_api.py`
- `get_balance()`: API-ID kt00001 ì‚¬ìš©
- `get_account_info()`: API-ID ka01690 ì‚¬ìš©
- ì—”ë“œí¬ì¸íŠ¸: `/api/dostk/acnt`
- ìš”ì²­ ë°©ì‹: POST (JSON body)

### 2. `main_auto_trading.py`
- `initialize_account()`: ì‹¤ê³„ì¢Œ íŒŒì‹± ë¡œì§
- `update_account_balance()`: ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- ë³´ìœ  í¬ì§€ì…˜ ë¡œë“œ: ì‹¤ì œ API ì‘ë‹µ íŒŒì‹±

### 3. `core/risk_manager.py`
- `update_balance()`: ì‹¤ì‹œê°„ ì”ê³  ì—…ë°ì´íŠ¸ ë©”ì„œë“œ ì¶”ê°€

### 4. í…ŒìŠ¤íŠ¸ íŒŒì¼
- `test/test_account_integration.py`: ê¸°ë³¸ í…ŒìŠ¤íŠ¸
- `test/test_real_account_integration.py`: ì‹¤ê³„ì¢Œ í†µí•© í…ŒìŠ¤íŠ¸ (ì‹ ê·œ)

---

## ğŸš€ ì›”ìš”ì¼ ì‹¤ì „ íˆ¬ì… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] í‚¤ì›€ OpenAPI ì—”ë“œí¬ì¸íŠ¸ í™•ì •
- [x] ê³„ì¢Œ ì¡°íšŒ API êµ¬í˜„ ë° ê²€ì¦
- [x] ì‹¤ê³„ì¢Œ ê¸°ë°˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì—°ë™
- [x] í¬ì§€ì…˜ í¬ê¸° ë™ì  ê³„ì‚°
- [x] ì‹¤ì‹œê°„ ì”ê³  ì—…ë°ì´íŠ¸
- [x] í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼
- [x] ì˜ˆì™¸ ì²˜ë¦¬ ì™„ë£Œ

**ìƒíƒœ:** ğŸŸ¢ ì‹¤ì „ íˆ¬ì… ì¤€ë¹„ ì™„ë£Œ

---

## ğŸ” ì£¼ìš” ê°œì„  ì‚¬í•­

### 1. API ì—”ë“œí¬ì¸íŠ¸ ì •í™•ë„
- **ì´ì „:** ì¶”ì • ì—”ë“œí¬ì¸íŠ¸ â†’ 500 ì—ëŸ¬
- **ê°œì„ :** ê³µì‹ ë¬¸ì„œ ê¸°ë°˜ â†’ ì •ìƒ ì‘ë™

### 2. ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì •í™•ì„±
- **ì´ì „:** ê°€ìƒ 1000ë§Œì› ê³ ì •
- **ê°œì„ :** ì‹¤ì‹œê°„ 425,654ì› (ì‹¤ê³„ì¢Œ)

### 3. í¬ì§€ì…˜ í¬ê¸° ê³„ì‚°
- **ì´ì „:** ë¶€ì •í™• (ê°€ìƒ ì”ê³  ê¸°ë°˜)
- **ê°œì„ :** ì •í™• (ì‹¤ì œ ì”ê³  Ã— 2% ë¦¬ìŠ¤í¬)

### 4. ê³„ì¢Œ ë™ê¸°í™”
- **ì´ì „:** ìˆ˜ë™ ê´€ë¦¬ í•„ìš”
- **ê°œì„ :** ë§¤ìˆ˜/ë§¤ë„ í›„ ìë™ ê°±ì‹ 

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒì‚¬í•­)

### 1. ì¶”ê°€ API êµ¬í˜„ (í•„ìš”ì‹œ)
- `ka10074`: ì¼ìë³„ ì‹¤í˜„ì†ìµ ì¡°íšŒ
- `ka10072`: ì¢…ëª©ë³„ ì‹¤í˜„ì†ìµ ì¡°íšŒ
- ì†ìµ í†µê³„ ìë™ ê¸°ë¡

### 2. ë°±ê·¸ë¼ìš´ë“œ ì”ê³  ê°±ì‹  (ì„ íƒ)
```python
# ë§¤ìˆ˜/ë§¤ë„ í›„
asyncio.create_task(self.update_account_balance())
```

### 3. ëª¨ë‹ˆí„°ë§ ê°•í™”
- ì¼ì¼ ì†ìµ ì•Œë¦¼
- í¬ì§€ì…˜ ë¹„ìœ¨ ê²½ê³ 
- ë¦¬ìŠ¤í¬ í•œë„ ì•Œë¦¼

---

## ğŸ‰ ì™„ë£Œ!

**ì´ ì‘ì—… ì‹œê°„:** ì•½ 2ì‹œê°„
**í…ŒìŠ¤íŠ¸ ê²°ê³¼:** âœ… 100% í†µê³¼
**ì‹¤ì „ ì¤€ë¹„:** ğŸŸ¢ ì™„ë£Œ

**ë‹¤ìŒ ì‹¤í–‰:**
```bash
cd /home/greatbps/projects/kiwoom_trading
./run.sh
```

**ì›”ìš”ì¼ (2025-10-28) 09:00 ì‹¤ì „ íˆ¬ì… ì˜ˆì •**

---

**ì‘ì„±ì:** Claude Code
**ê²€ì¦ì¼:** 2025-10-26 15:45
