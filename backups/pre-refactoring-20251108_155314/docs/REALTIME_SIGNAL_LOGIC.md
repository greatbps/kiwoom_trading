# 실시간 매수/매도 시그널 발생 로직

## 🔄 메인 루프 (1분마다 실행)

```python
while 시스템_실행중:
    # 1. 장 운영 시간 확인
    if not 장_운영_시간:
        60초 대기
        continue

    # 2. 보유 종목 모니터링 → 매도 시그널 체크
    for position in 보유_포지션:
        현재가 조회
        매도_신호 = check_exit_signals(position, 현재가)

        if 매도_신호:
            매도_실행()

    # 3. 관심 종목 스캔 → 매수 시그널 체크
    매수_후보 = scan_for_buy_signals()

    if 매수_후보:
        매수_실행()

    # 4. 60초 대기 후 다시 반복
    time.sleep(60)
```

---

## 💰 매수 시그널 발생 (실시간)

### 🎯 발생 조건
```python
# 이미 조건검색에서 통과한 종목들을 관심종목에 등록
watchlist = [
    "코스모신소재",  # 76.73점
    "로보스타",      # 77.43점
    ...
]

# 1분마다 관심종목 스캔
for stock in watchlist:
    현재가 = get_current_price(stock)

    # 재분석 (뉴스+기술+수급+기본)
    score = analyze(stock, 현재가)

    if score >= 70:  # STRONG_BUY
        if 리스크_체크_통과:
            → 매수 시그널 발생! 🟢
```

### 📋 리스크 체크
```python
# 매수 전 리스크 체크
1. 일일 손실 한도 (-5%) 미달성
2. 일일 거래 횟수 (10회) 미초과
3. 포지션 개수 (5개) 미만
4. 현금 잔고 충분
5. 개별 포지션 크기 30% 이하

→ 모두 통과하면 매수 주문 실행!
```

### 💡 매수 실행
```python
# 실제 매수 주문
api.order_buy(
    stock_code="005070",      # 코스모신소재
    quantity=300,             # 300주
    price=10000,              # 10,000원 (지정가)
    trade_type="0"            # 지정가
)

# 포지션 생성
position = {
    'stock_code': "005070",
    'stock_name': "코스모신소재",
    'quantity': 300,
    'avg_price': 10000,
    'current_price': 10000,
    'buy_time': "2025-10-25 09:30:00",

    # 목표가 (3단계)
    'target1': 11500,   # +15% (ATR 1.5배)
    'target2': 12500,   # +25% (ATR 2.5배)
    'target3': 14000,   # +40% (ATR 4.0배)

    # 손절가
    'stop_loss': 9500,  # -5% (ATR 2배)

    # 진입 정보
    'entry_signal': "STRONG_BUY",
    'entry_score': 76.73,

    # 매도 단계 (0: 진입, 1: 1차익절, 2: 2차익절, 3: Trailing)
    'stage': 0
}

→ 포지션 관리 시작! 📊
```

---

## 📈 매도 시그널 발생 (실시간 6단계)

### 🎯 매 1분마다 체크

```python
# 보유 포지션별로 매 1분마다 체크
for position in 보유_포지션:
    현재가 = get_current_price(position)
    수익률 = (현재가 - 매수가) / 매수가

    # 6단계 매도 전략 체크 (우선순위 순)
```

### 6️⃣ 단계: 장 마감 전 강제 청산 (최우선!)
```python
if 현재시간 >= "15:00:00":
    → 전량 매도! ⏰
    이유 = "6단계: 장 마감 전 강제 청산"
```

### 1️⃣ 단계: Hard Stop (-3%)
```python
if 수익률 <= -3%:
    → 전량 매도! 🛑
    이유 = "1단계: Hard Stop (-3%)"

예시:
  매수가: 10,000원
  현재가: 9,700원 (-3%)
  → 300주 전량 매도 (손실 90,000원)
```

### 2️⃣ 단계: 1차 익절 (+4%)
```python
if stage == 0 and 수익률 >= +4%:
    → 40% 매도! 💰
    이유 = "2단계: 1차 익절 (+4%, 40% 매도)"
    stage = 1  # 단계 업데이트

예시:
  매수가: 10,000원
  현재가: 10,400원 (+4%)
  → 120주 매도 (40%, 이익 48,000원)
  → 잔여: 180주
  → stage 0 → 1 변경
```

### 3️⃣ 단계: 2차 익절 (+6%)
```python
if stage == 1 and 수익률 >= +6%:
    → 40% 매도! 💰💰
    이유 = "3단계: 2차 익절 (+6%, 40% 매도, Trailing 활성화)"
    stage = 2  # 단계 업데이트
    trailing_stop 활성화!

예시:
  매수가: 10,000원
  현재가: 10,600원 (+6%)
  → 120주 매도 (40%, 이익 72,000원)
  → 잔여: 60주 (20%)
  → stage 1 → 2 변경
  → trailing_stop = 10,600 - (ATR × 2) = 10,200원
```

### 4️⃣ 단계: ATR Trailing Stop
```python
if stage >= 2:
    # Trailing Stop 계산
    if 현재가 > trailing_stop:
        # 신고가 갱신 → Trailing Stop 상향 조정
        trailing_stop = 현재가 - (ATR × 2)

    # Trailing Stop 도달 체크
    if 현재가 <= trailing_stop:
        → 잔량 전량 매도! 📉
        이유 = "4단계: Trailing Stop 도달"

예시:
  최고가: 11,000원
  ATR: 200원
  trailing_stop = 11,000 - (200 × 2) = 10,600원

  현재가: 10,550원
  → 60주 전량 매도 (이익 33,000원)
```

### 5️⃣ 단계: EMA + Volume Breakdown (추세 전환)
```python
# 20일 EMA 이탈 감지
if 현재가 < EMA20 and 거래량 > 평균거래량 × 1.5:
    if 신뢰도 == HIGH:
        → 전량 매도! 📊
        이유 = "5단계: EMA Breakdown (HIGH)"

    elif 신뢰도 == MEDIUM and 수익률 < 0:
        → 전량 매도! 📊
        이유 = "5단계: EMA Breakdown (MEDIUM)"

예시:
  EMA20: 10,300원
  현재가: 10,150원 (EMA 이탈)
  거래량: 150% 급증
  → 추세 전환 감지 → 전량 매도
```

### 🔒 백업: 기본 손절가
```python
# 위 5단계 모두 해당 없을 때
if 현재가 <= stop_loss:
    → 전량 매도! 🛡️
    이유 = "손절가 도달"

예시:
  손절가: 9,500원
  현재가: 9,450원
  → 전량 매도
```

---

## 🎬 실제 매매 시나리오

### 시나리오 1: 성공 케이스 (큰 수익)

```
09:30 → 매수
  코스모신소재 300주 @ 10,000원

10:15 → 1차 익절 (+4%)
  현재가: 10,400원
  매도: 120주 (40%)
  수익: +48,000원
  잔여: 180주

11:30 → 2차 익절 (+6%)
  현재가: 10,600원
  매도: 120주 (40%)
  수익: +72,000원
  잔여: 60주
  → Trailing Stop 활성화 (10,200원)

13:45 → 최고가 갱신
  현재가: 11,500원 (+15%)
  → Trailing Stop 상향: 11,100원

14:20 → Trailing Stop 도달
  현재가: 11,050원
  매도: 60주 (20%)
  수익: +63,000원

총 수익: +183,000원 (+6.1%)
```

### 시나리오 2: 손절 케이스

```
09:30 → 매수
  로보스타 300주 @ 10,000원

09:45 → 급락
  현재가: 9,700원 (-3%)
  → Hard Stop 도달!
  매도: 300주 (100%)
  손실: -90,000원

총 손실: -90,000원 (-3%)
→ 손실 제한 성공! ✅
```

### 시나리오 3: 장 마감 청산

```
09:30 → 매수
  파미셀 300주 @ 10,000원

15:00 → 장 마감 30분 전
  현재가: 10,150원 (+1.5%)
  → 강제 청산!
  매도: 300주 (100%)
  수익: +45,000원

총 수익: +45,000원 (+1.5%)
→ 익일 갭 리스크 회피! ✅
```

---

## ⚙️ 핵심 파라미터

```python
# 매도 전략 파라미터
HARD_STOP_RATE = -3%        # 하드 스탑
PARTIAL_TP1_RATE = +4%      # 1차 익절
PARTIAL_TP2_RATE = +6%      # 2차 익절

PARTIAL_SELL_RATIO_1 = 40%  # 1차 익절 매도 비율
PARTIAL_SELL_RATIO_2 = 40%  # 2차 익절 매도 비율
TRAILING_RATIO = 20%        # Trailing 대상 비율

FORCE_CLOSE_TIME = "15:00"  # 강제 청산 시간
TRAILING_ATR_MULTIPLIER = 2 # Trailing Stop (ATR × 2)
```

---

## 🔄 실시간 처리 흐름

```
[메인 루프 - 1분마다]
    ↓
┌─────────────────────────────────┐
│ 1. 보유 포지션 체크             │
├─────────────────────────────────┤
│ 코스모신소재: 10,400원 (+4%)    │
│ → 1차 익절! 120주 매도          │
├─────────────────────────────────┤
│ 로보스타: 10,150원 (+1.5%)      │
│ → 유지 (stage 0)                │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 2. 관심 종목 스캔               │
├─────────────────────────────────┤
│ 산일전기: 재분석 73.18점        │
│ → 리스크 체크 통과              │
│ → 매수! 250주 @ 12,000원        │
└─────────────────────────────────┘
    ↓
    60초 대기
    ↓
    다시 반복
```

---

## 📊 모니터링 화면 예시

```
================================================
[Loop #145] 2025-10-25 14:20:15
================================================

📊 계좌 현황
  현금: 7,000,000원
  포지션: 3,000,000원 (3개)
  미실현 손익: +150,000원

⚖️ 리스크 지표
  총 자산: 10,150,000원
  현금 비율: 69.0%
  일일 손익: +150,000원 (+1.50%)
  손실 허용: 350,000원
  거래 횟수: 5/10

📈 보유 포지션 모니터링
  • 코스모신소재: 10,600원 (+6.00%) - 2차익절
  • 로보스타: 11,050원 (+5.00%) - 1차익절
  • 산일전기: 12,150원 (+1.25%) - 진입

🔍 매수 신호 스캔
  ✅ 매수 후보 2개 발견
    1. 대한전선 - STRONG_BUY (점수: 73.15)
    2. 이수페타시스 - BUY (점수: 72.73)

💰 매수 시도: 대한전선
  ✅ 매수 성공: 300주 @ 9,800원

💤 60초 대기 중...
```

---

## ✅ 핵심 포인트

1. **실시간 모니터링**: 1분마다 모든 포지션 체크
2. **6단계 매도 전략**: 우선순위에 따라 자동 매도
3. **분할 익절**: 1차 40% + 2차 40% + Trailing 20%
4. **Hard Stop**: -3%에서 무조건 손절
5. **Trailing Stop**: 2차 익절 후 자동 활성화
6. **추세 전환 감지**: EMA + 거래량으로 조기 청산
7. **장 마감 리스크 회피**: 15:00 전 강제 청산

→ **완전 자동화된 실시간 매매 시스템!** 🤖

---

**작성일**: 2025-10-25
**최종 수정**: 2025-10-25
