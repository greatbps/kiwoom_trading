# 거래량 로직 분석 및 개선 제안 (Gemini 분석)

## 1. 현재 거래량 로직 분석

`main_auto_trading.py`의 `check_all_stocks` 함수에 구현된 현재 거래량 증감률 계산 로직은 다음과 같습니다.

```python
# 1. 5분봉 데이터 기준, 20개 봉(총 100분)의 평균 거래량을 계산
df['volume_ma20'] = df['volume'].rolling(window=20).mean()

# 2. 가장 최신 5분봉의 거래량과 위에서 구한 평균 거래량을 가져옴
current_volume = df['volume'].iloc[-1]
avg_volume = df['volume_ma20'].iloc[-1]

# 3. 현재 거래량이 평균 거래량 대비 몇 %나 다른지 계산
volume_change_pct = ((current_volume - avg_volume) / avg_volume * 100) if avg_volume > 0 else 0
```

이 로직은 **'가장 최신 5분'**의 순간 거래량을 **'지난 100분의 평균 거래량'**과 직접 비교합니다.

## 2. 문제점: 높은 변동성 및 노이즈

### 원인
이 방식은 순간적인 값과 장기 평균 값을 비교하기 때문에 변동성이 매우 클 수밖에 없습니다.
- **급등**: 단 한 번의 대량 주문으로도 순간 거래량은 폭증하여 비정상적으로 높은 양수 값을 보입니다.
- **급락**: 거래가 잠시 소강상태에 빠지면 순간 거래량은 0에 가까워져 -100%에 가까운 음수 값을 보입니다.

### 전문가적 판단
현재 로직은 "순간적인 시장 관심도 폭발"을 감지하는 데는 유용하지만, 안정적인 매수 신호로 사용하기에는 **노이즈(noise)가 매우 심하고 기만적(whipsaw)일 수 있습니다.** 일시적인 단발성 거래와 지속적인 관심의 증가를 구분하지 못하여 잘못된 신호를 자주 발생시킬 위험이 있습니다.

## 3. 개선 제안

단기적인 노이즈를 줄이고 신호의 신뢰도를 높이기 위해 다음과 같은 개선 방안을 제안합니다.

### 제안 1: 단기/장기 거래량 이동평균 비교 (권장)

순간 거래량 대신, 단기 거래량 이동평균을 사용하여 '거래량의 추세'를 파악하는 것이 훨씬 안정적입니다.

#### 수정 제안 코드
```python
# 5개 봉(25분)의 단기 평균 거래량 계산
df['volume_ma5'] = df['volume'].rolling(window=5).mean() 
# 20개 봉(100분)의 장기 평균 거래량 계산
df['volume_ma20'] = df['volume'].rolling(window=20).mean()

# 최신 단기/장기 평균 거래량을 가져옴
short_term_avg_vol = df['volume_ma5'].iloc[-1]
long_term_avg_vol = df['volume_ma20'].iloc[-1]

# 단기 평균이 장기 평균을 얼마나 넘어섰는지 계산 (표시용)
volume_change_pct = ((short_term_avg_vol - long_term_avg_vol) / long_term_avg_vol * 100) if long_term_avg_vol > 0 else 0

# 매수 조건: 단기 거래량 추세가 장기 거래량 추세를 상향 돌파했는가?
condition_volume = short_term_avg_vol > long_term_avg_vol 
```

#### 기대 효과
- 순간적인 급등락이 아닌, **최소 25분 이상 거래가 활발하게 유지**되고 있다는 '추세'를 확인할 수 있습니다.
- 이를 통해 훨씬 더 안정적이고 신뢰도 높은 신호를 얻을 수 있으며, 화면에 표시되는 값의 변동성도 눈에 띄게 줄어들 것입니다.

### 제안 2: 상대 거래량 (Relative Volume, RVOL) 도입 (고급)

더 발전된 방식으로는 '오늘 현재까지의 누적 거래량'을 '어제 같은 시간까지의 누적 거래량'과 비교하는 **상대 거래량(RVOL)** 지표를 사용하는 것입니다. 이는 "평소보다 거래가 활발한가?"를 가장 정확하게 알려주는 지표 중 하나로 인정받고 있습니다.

## 4. 결론

현재 거래량 로직의 변동성이 크다는 사용자의 직관은 매우 정확합니다. 이는 안정적인 매매 전략에 사용되기에는 노이즈가 심한 방식입니다.

**`제안 1`과 같이 단기 이동평균과 장기 이동평균을 비교하는 방식으로 로직을 수정**한다면, 훨씬 더 안정적이고 신뢰할 수 있는 거래량 기반의 매매 신호를 얻을 수 있을 것입니다.
