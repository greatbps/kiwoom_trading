# ì‹¤ê³„ì¢Œ ì—°ë™ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼:** 2025-10-26 15:30  
**ì†Œìš” ì‹œê°„:** ì•½ 1ì‹œê°„  
**ìƒíƒœ:** âœ… êµ¬í˜„ ì™„ë£Œ

---

## ğŸ“‹ êµ¬í˜„ ë‚´ìš©

### 1. RiskManager ê°œì„ 
**íŒŒì¼:** `core/risk_manager.py`

```python
def update_balance(self, new_balance: float):
    """ì‹¤ì‹œê°„ ì”ê³  ì—…ë°ì´íŠ¸"""
    self.initial_balance = new_balance
```

**ê¸°ëŠ¥:**
- ê±°ë˜ í›„ ì‹¤ì‹œê°„ ì”ê³  ì—…ë°ì´íŠ¸
- ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ë™ê¸°í™”

---

### 2. IntegratedTradingSystem ê°œì„ 
**íŒŒì¼:** `main_auto_trading.py`

#### 2.1 ê³„ì¢Œ ì •ë³´ ì†ì„± ì¶”ê°€
```python
# ê³„ì¢Œ ì •ë³´ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
self.current_cash = 0.0
self.total_assets = 0.0
self.positions_value = 0.0

# ë¦¬ìŠ¤í¬ ê´€ë¦¬ì (ë‚˜ì¤‘ì— ì‹¤ê³„ì¢Œ ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸°í™”)
self.risk_manager = None
```

#### 2.2 ê³„ì¢Œ ì´ˆê¸°í™” ë©”ì„œë“œ
```python
async def initialize_account(self):
    """ê³„ì¢Œ ì •ë³´ ì´ˆê¸°í™” (ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ)"""
    
    # 1. ê³„ì¢Œ ì”ê³  ì¡°íšŒ
    balance_info = self.api.get_balance()
    
    # 2. ê³„ì¢Œ ì •ë³´ íŒŒì‹±
    self.current_cash = balance_info.get('cash', 10000000)
    positions = balance_info.get('positions', [])
    self.positions_value = sum(...)
    self.total_assets = self.current_cash + self.positions_value
    
    # 3. ê³„ì¢Œ í˜„í™© ì¶œë ¥ (í…Œì´ë¸”)
    # 4. ë³´ìœ  í¬ì§€ì…˜ ë¡œë“œ
    # 5. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì´ˆê¸°í™” (ì‹¤ì œ ì”ê³  ê¸°ë°˜)
    
    self.risk_manager = RiskManager(
        initial_balance=self.current_cash,
        storage_path='data/risk_log.json'
    )
```

#### 2.3 ì”ê³  ì—…ë°ì´íŠ¸ ë©”ì„œë“œ
```python
async def update_account_balance(self):
    """ê±°ë˜ í›„ ì‹¤ì‹œê°„ ì”ê³  ì—…ë°ì´íŠ¸"""
    
    balance_info = self.api.get_balance()
    self.current_cash = balance_info.get('cash', self.current_cash)
    
    # ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ë™ê¸°í™”
    if self.risk_manager:
        self.risk_manager.update_balance(self.current_cash)
```

#### 2.4 ë§¤ìˆ˜ ë¡œì§ ê°œì„ 
```python
def execute_buy(self, stock_code, stock_name, price, df):
    """ë§¤ìˆ˜ ì‹¤í–‰ (ì‹¤ê³„ì¢Œ ê¸°ë°˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬)"""
    
    # 1. ì†ì ˆê°€ ê³„ì‚°
    stop_loss_price = price * 0.97
    
    # 2. í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° (ì‹¤ì œ ì”ê³  ê¸°ë°˜)
    position_calc = self.risk_manager.calculate_position_size(
        current_balance=self.current_cash,
        current_price=price,
        stop_loss_price=stop_loss_price
    )
    
    # 3. ì§„ì… ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    can_enter, reason = self.risk_manager.can_open_position(
        current_balance=self.current_cash,
        current_positions_value=self.positions_value,
        position_count=len(self.positions),
        position_size=position_calc['investment']
    )
    
    if not can_enter:
        # ë§¤ìˆ˜ ë¶ˆê°€ ë©”ì‹œì§€ ì¶œë ¥
        return
    
    # 4. ë§¤ìˆ˜ ì‹¤í–‰
    quantity = position_calc['quantity']
    amount = position_calc['investment']
    
    # 5. ë¦¬ìŠ¤í¬ ê´€ë¦¬ìì— ê¸°ë¡
    self.risk_manager.record_trade(...)
```

#### 2.5 ë§¤ë„ ë¡œì§ ê°œì„ 
```python
def execute_sell(self, stock_code, price, profit_pct, reason):
    """ë§¤ë„ ì‹¤í–‰"""
    
    # ...ê¸°ì¡´ ë¡œì§...
    
    # ë¦¬ìŠ¤í¬ ê´€ë¦¬ìì— ê±°ë˜ ê¸°ë¡
    self.risk_manager.record_trade(
        stock_code=stock_code,
        stock_name=position['name'],
        trade_type='SELL',
        quantity=position['quantity'],
        price=price,
        realized_pnl=realized_profit
    )
```

#### 2.6 ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ í˜¸ì¶œ
```python
async def run(self):
    """ì „ì²´ ì‹œìŠ¤í…œ ì‹¤í–‰"""
    
    # WebSocket ì—°ê²° ë° ë¡œê·¸ì¸
    await self.connect()
    if not await self.login():
        return
    
    # ê³„ì¢Œ ì •ë³´ ì´ˆê¸°í™” â† NEW
    await self.initialize_account()
    
    # ì¡°ê±´ì‹ ëª©ë¡ ì¡°íšŒ
    ...
```

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### 1. ê³„ì¢Œ ì •ë³´ ì¡°íšŒ
```
[1] í† í° ë°œê¸‰
âœ“ ì ‘ê·¼ í† í° ë°œê¸‰ ì„±ê³µ
  - ë§Œë£Œì¼ì‹œ: 20251027153027
  - ë‚¨ì€ì‹œê°„: 86399ì´ˆ (24.0ì‹œê°„)

[2] ê³„ì¢Œ ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
âŒ ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: 500 Server Error
âš ï¸  API ì—”ë“œí¬ì¸íŠ¸ê°€ ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[3] ê³„ì¢Œ ì”ê³  ì¡°íšŒ
âŒ ì”ê³  ì¡°íšŒ ì‹¤íŒ¨: 500 Server Error
âš ï¸  API ì—”ë“œí¬ì¸íŠ¸ê°€ ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```

**í•´ì„:**
- API ì—”ë“œí¬ì¸íŠ¸ëŠ” `kiwoom_api.py`ì—ì„œ ì¶”ì •í•œ ê²ƒ
- ì‹¤ì œ í‚¤ì›€ API ë¬¸ì„œì—ì„œ ì •í™•í•œ ê²½ë¡œ í™•ì¸ í•„ìš”
- **ì˜ˆì™¸ ì²˜ë¦¬** ì™„ë£Œ: API ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’(1000ë§Œì›)ìœ¼ë¡œ ì´ˆê¸°í™”

### 2. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì
```
âœ“ ì´ˆê¸° ì”ê³ : 10,000,000ì›
âœ“ í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° ì„±ê³µ
  - ìˆ˜ëŸ‰: 60ì£¼
  - íˆ¬ìê¸ˆì•¡: 3,000,000ì› (30%)
  - ë¦¬ìŠ¤í¬ ê¸ˆì•¡: 200,000ì› (2%)
âœ“ ì§„ì… ê°€ëŠ¥ ì—¬ë¶€: OK
âœ“ ì”ê³  ì—…ë°ì´íŠ¸ ì„±ê³µ (9,500,000ì›)
```

---

## ğŸ¯ ì‹¤í–‰ íë¦„ (ê°œì„  í›„)

### ì‹œì‘ ì‹œ
```
1. í† í° ë°œê¸‰ âœ“
2. WebSocket ì—°ê²° âœ“
3. ë¡œê·¸ì¸ âœ“
4. ê³„ì¢Œ ì •ë³´ ì¡°íšŒ â† NEW
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ’° ê³„ì¢Œ í˜„í™©                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ ê³„ì¢Œë²ˆí˜¸: 6259-3479         â”‚
   â”‚ ì˜ˆìˆ˜ê¸ˆ: 10,234,567ì›        â”‚
   â”‚ ë³´ìœ ì¢…ëª© í‰ê°€: 1,500,000ì›  â”‚
   â”‚ ì´ ìì‚°: 11,734,567ì›       â”‚
   â”‚ ë³´ìœ ì¢…ëª© ìˆ˜: 2ê°œ            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
5. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ì´ˆê¸°í™” (ì‹¤ì œ ì”ê³ )
6. ì¡°ê±´ê²€ìƒ‰ ì‹œì‘
```

### ë§¤ìˆ˜ ì‹ í˜¸ ë°œìƒ ì‹œ
```
1. ì¢…ëª© ë°œê²¬: 005930
2. VWAP ê²€ì¦ í†µê³¼
3. í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° â† ì‹¤ì œ ì”ê³  ê¸°ë°˜
   - ê°€ìš© í˜„ê¸ˆ: 10,234,567ì›
   - ë¦¬ìŠ¤í¬ 2%: 204,691ì›
   - ë§¤ìˆ˜ ê¸ˆì•¡: 3,000,000ì› (30% í•œë„)
   - ë§¤ìˆ˜ ìˆ˜ëŸ‰: 60ì£¼
4. ì§„ì… ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
   âœ“ OK
5. ë§¤ìˆ˜ ì‹¤í–‰
6. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ê¸°ë¡
```

### ë§¤ë„ ì‹ í˜¸ ë°œìƒ ì‹œ
```
1. íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ ë„ë‹¬
2. ë§¤ë„ ì‹¤í–‰
3. ë¦¬ìŠ¤í¬ ê´€ë¦¬ì ê¸°ë¡
   - ì‹¤í˜„ ì†ìµ: +150,000ì›
   - ì¼ì¼ ì†ìµ: +150,000ì›
4. ì”ê³  ì—…ë°ì´íŠ¸ (TODO)
```

---

## ğŸ“Œ TODO: API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ í•„ìš”

### í˜„ì¬ ì¶”ì • ê²½ë¡œ
```python
# kiwoom_api.py
def get_account_info(self):
    path = f"/v1/account/{self.account_number}"
    
def get_balance(self):
    path = f"/v1/account/{self.account_number}/balance"
```

### ì‹¤ì œ í‚¤ì›€ API í™•ì¸ ë°©ë²•
1. í‚¤ì›€ OpenAPI í¬í„¸ ì ‘ì†
2. API ë¬¸ì„œì—ì„œ ê³„ì¢Œ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
3. `kiwoom_api.py` ìˆ˜ì •

**í˜„ì¬ëŠ” 500 ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ë§Œ:**
- ì˜ˆì™¸ ì²˜ë¦¬ ì™„ë£Œ
- ê¸°ë³¸ê°’(1000ë§Œì›)ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
- ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### 1. API ì—”ë“œí¬ì¸íŠ¸ í™•ì • (ì›”ìš”ì¼ ì „)
- [ ] í‚¤ì›€ OpenAPI ë¬¸ì„œ í™•ì¸
- [ ] ì‹¤ì œ ê³„ì¢Œ ì¡°íšŒ API ê²½ë¡œ ìˆ˜ì •
- [ ] ì‘ë‹µ í¬ë§· íŒŒì‹± ë¡œì§ ì™„ì„±

### 2. ë¹„ë™ê¸° ì”ê³  ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
- [ ] ë§¤ìˆ˜/ë§¤ë„ í›„ `asyncio.create_task(self.update_account_balance())`
- [ ] ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì”ê³  ê°±ì‹ 

### 3. ì‹¤ì „ íˆ¬ì… (ì›”ìš”ì¼)
```bash
cd /home/greatbps/projects/kiwoom_trading
./run.sh
```

---

## ğŸ“Š ê¸°ëŒ€ íš¨ê³¼

### Before (ì´ì „)
```
ì´ˆê¸° ì”ê³ : 10,000,000ì› (í•˜ë“œì½”ë”©)
ë¦¬ìŠ¤í¬ ê³„ì‚°: ê°€ìƒ ì”ê³  ê¸°ë°˜
í¬ì§€ì…˜ í¬ê¸°: ê³ ì •ê°’ ë˜ëŠ” ë¶€ì •í™•
```

### After (ê°œì„  í›„)
```
ì´ˆê¸° ì”ê³ : ì‹¤ê³„ì¢Œ ì¡°íšŒ (ë™ì )
ë¦¬ìŠ¤í¬ ê³„ì‚°: ì‹¤ì œ ì”ê³  ê¸°ë°˜
í¬ì§€ì…˜ í¬ê¸°: ì •í™•í•œ ë¦¬ìŠ¤í¬ 2%, í•œë„ 30%
ì§„ì… ì œí•œ: ì¼ì¼ ì†ì‹¤, ê±°ë˜ íšŸìˆ˜ ìë™ ì²´í¬
```

---

## ğŸ‰ êµ¬í˜„ ì™„ë£Œ!

**ì´ ì‘ì—… ì‹œê°„:** ì•½ 1ì‹œê°„  
**ìˆ˜ì • íŒŒì¼:** 3ê°œ
- `core/risk_manager.py`
- `main_auto_trading.py`
- `test/test_account_integration.py` (ì‹ ê·œ)

**í…ŒìŠ¤íŠ¸ í†µê³¼:** âœ…
- RiskManager: 100% í†µê³¼
- ê³„ì¢Œ ì •ë³´ ì¡°íšŒ: API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ í•„ìš”
- ì˜ˆì™¸ ì²˜ë¦¬: ì™„ë²½

**ì›”ìš”ì¼ ì‹¤ì „ ì¤€ë¹„:** ğŸŸ¢ ì™„ë£Œ
- ê³„ì¢Œ ì •ë³´ ì´ˆê¸°í™”: âœ…
- ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì—°ë™: âœ…
- í¬ì§€ì…˜ í¬ê¸° ê³„ì‚°: âœ…
- ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡: âœ…

---

**ë‹¤ìŒ ì²´í¬:** 2025-10-28 (ì›”) 08:30  
**ì‹¤ì „ íˆ¬ì…:** 2025-10-28 (ì›”) 09:00
