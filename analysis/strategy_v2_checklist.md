# 전략 업그레이드 v2 - 실시간 체크리스트

## 📋 진입 전 체크리스트

| # | 조건 | 확인 |
|---|------|------|
| 1 | CHoCH[A급] 상승전환 확인 | ☐ |
| 2 | Liquidity Sweep Low 발생 | ☐ |
| 3 | OB(bullish) 구간 진입 | ☐ |
| 4 | VWAP 상단 위치 | ☐ |
| 5 | 시간대 필터 (09:30~12:00, 14:00~14:59) | ☐ |

---

## 🔴 청산 규칙 v2

### 1. Early Failure Cut v2

```
[구버전] -1.6% in 30분 → 즉시 손절 ❌

[신버전]
┌─────────────────────────────────────────────┐
│ 모든 조건 충족 시에만 손절:                    │
│                                             │
│ ✓ 진입 후 45분 경과                          │
│ ✓ HTF CHoCH 무효화                          │
│ ✓ 종가 기준 VWAP -2.5% 이탈                  │
│ ✓ LL(Lower Low) 확정                        │
└─────────────────────────────────────────────┘
```

**체크리스트:**

| 조건 | 상태 | 손절 가능? |
|------|------|-----------|
| 45분 미경과 | - | ❌ 절대 금지 |
| HTF CHoCH 유지 | - | ❌ 관찰만 |
| VWAP -2.5% 미만 | - | ❌ 관찰만 |
| LL 미확정 | - | ❌ 관찰만 |
| **모두 충족** | - | ✅ 손절 |

---

### 2. VWAP 이탈 규칙 (30분 손절 금지)

```
┌─────────────────────────────────────────────┐
│ 0~30분: VWAP 하회해도 손절 금지              │
│ 30~60분: VWAP 하회 시 관찰                  │
│ 60분+: VWAP 하회 + 구조 이탈 → 손절         │
└─────────────────────────────────────────────┘
```

**시간별 대응:**

| 보유시간 | VWAP 하회 | 구조 이탈 | 액션 |
|----------|----------|----------|------|
| 0~30분 | O | - | 관찰 |
| 30~60분 | O | X | 관찰 |
| 30~60분 | O | O | 관찰 (60분 대기) |
| 60분+ | O | O | **손절** |
| 60분+ | O | X | 관찰 |

---

### 3. 포지션 생명주기 (D+1, D+3, D+5)

```
┌─────────────────────────────────────────────┐
│ D+1 (익일 종가):                            │
│   └─ VWAP 상단 미유지 → 50% 청산            │
│                                             │
│ D+3:                                        │
│   └─ +0%~+3% → 전량 청산                    │
│   └─ +3% 이상 → 트레일링 강제 ON            │
│                                             │
│ D+5:                                        │
│   └─ 무조건 전량 청산                        │
└─────────────────────────────────────────────┘
```

**일별 체크:**

| 보유일 | 수익률 | 액션 |
|--------|--------|------|
| D+1 | VWAP 하회 | 50% 청산 |
| D+3 | +0% ~ +3% | 전량 청산 |
| D+3 | +3% 이상 | 트레일링 ON |
| D+5 | 무관 | **강제 전량 청산** |

---

### 4. ATR 트레일링 단계화

```
┌─────────────────────────────────────────────┐
│ +0% ~ +2%:  트레일링 OFF (구조 기준만)       │
│ +2% ~ +4%:  ATR × 3.0 (느슨)               │
│ +4% 이상:   ATR × 2.0 (수익 보호)           │
└─────────────────────────────────────────────┘
```

**수익률별 트레일링:**

| 현재 수익 | ATR 배수 | 스탑 거리 (ATR=2000 기준) |
|-----------|----------|-------------------------|
| +1.5% | OFF | - |
| +2.5% | × 3.0 | 6,000원 |
| +3.5% | × 3.0 | 6,000원 |
| +4.5% | × 2.0 | 4,000원 |
| +6.0% | × 2.0 | 4,000원 |

---

## 📊 실시간 모니터링 화면

```
┌──────────────────────────────────────────────────────────┐
│ 종목: 인텔리안테크 (189300)                              │
│ 진입: 10:20 @ 76,200원                                  │
│ 현재: 10:45 @ 74,800원 (-1.84%)                         │
├──────────────────────────────────────────────────────────┤
│ [Early Failure v2]                                      │
│   보유시간: 25분 (< 45분) ❌                             │
│   HTF CHoCH: 유지 ❌                                    │
│   VWAP 이탈: -1.9% (> -2.5%) ❌                         │
│   LL 확정: 미확정 ❌                                    │
│   → 결과: 보유 (손절 조건 미충족)                        │
├──────────────────────────────────────────────────────────┤
│ [ATR 트레일링]                                          │
│   현재 수익: -1.84% → 트레일링 OFF                      │
├──────────────────────────────────────────────────────────┤
│ [포지션 생명주기]                                        │
│   보유일: D+0 → 해당 없음                               │
├──────────────────────────────────────────────────────────┤
│ 📋 최종 판단: HOLD (관찰)                               │
└──────────────────────────────────────────────────────────┘
```

---

## ✅ 백테스트 조건표

### 테스트 케이스

| # | 시나리오 | 기존 결과 | v2 예상 | 검증 포인트 |
|---|----------|----------|---------|------------|
| 1 | 인텔리안테크 01/23 | -2.49% (18분) | HOLD → 반등 | 45분 규칙 |
| 2 | 에이디테크놀로지 01/30 | -1.75% (19분) | HOLD → ? | 45분 규칙 |
| 3 | 인텔리안테크 01/27 | +2.06% | +33%? | ATR 단계화 |
| 4 | 아진엑스텍 01/26 | +0.12% (D+1) | D+1 50% | 생명주기 |

### 백테스트 SQL

```sql
-- 30분 이내 Early Failure 건 추출
SELECT * FROM trades
WHERE trade_type = 'SELL'
  AND exit_reason LIKE '%Early Failure%'
  AND holding_duration < 1800;  -- 30분

-- D+3 이상 보유 건
SELECT * FROM trades t1
JOIN trades t2 ON t1.stock_code = t2.stock_code
WHERE t1.trade_type = 'BUY'
  AND t2.trade_type = 'SELL'
  AND DATE(t2.trade_time) - DATE(t1.trade_time) >= 3;
```

---

## 🔧 코드 통합 위치

```
kiwoom_trading/
├── trading/
│   └── exit_logic_optimized.py  ← 기존 파일
│
├── analysis/
│   └── strategy_upgrade_v2.py   ← 신규 규칙 정의
│
└── config/
    └── strategy_hybrid.yaml     ← 파라미터 수정 필요
```

### strategy_hybrid.yaml 수정 사항

```yaml
# 기존
early_failure:
  threshold_pct: -1.6
  min_hold_minutes: 30

# 변경
early_failure_v2:
  threshold_pct: -2.5
  min_hold_minutes: 45
  require_htf_choch: true
  require_ll_break: true

# 기존
trailing:
  atr_multiplier: 2.0
  activation_profit_pct: 0.5

# 변경
trailing_v2:
  stage_1_threshold: 2.0    # +2%
  stage_2_threshold: 4.0    # +4%
  stage_1_atr_mult: 3.0     # 느슨
  stage_2_atr_mult: 2.0     # 타이트

# 신규
position_lifecycle:
  d1_partial_exit: 0.5      # 50%
  d3_profit_threshold: 3.0  # +3%
  d5_force_exit: true
```

---

## 📌 핵심 요약

| 규칙 | 기존 | v2 |
|------|------|-----|
| Early Failure | -1.6%, 30분 | -2.5%, 45분 + 구조 |
| VWAP 손절 | 즉시 | 60분 후 |
| ATR 트레일링 | 고정 x2.0 | 단계별 x3.0/x2.0 |
| 장기 보유 | 제한 없음 | D+5 강제 청산 |

---

**"진입은 스윙, 청산도 스윙"으로 통일**
